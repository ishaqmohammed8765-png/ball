import{r as Vt,g as Zt}from"./phaser-Czz4FBZH.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}})();var Jt=Vt();const R=Zt(Jt),it=8,gt=1/120,Lt=1e6,nt=760,pt=3,Qt=1.2,te=.1,ee=.35,se=24,ie=18,Et=1.2,Bt=1.25,oe=.09,ae=2.2,Pt=1100,ot=420,ne=4,re=1,Ht=["standard","crossfire","sanctum","gauntlet"],At=["none","iron_wall","glass_cannon","turbo"],W={hp:{label:"HP",maxLevel:8,baseCost:120,costScale:1.35,hpPerLevel:.08},speed:{label:"Speed",maxLevel:8,baseCost:115,costScale:1.32,speedPerLevel:.06},mastery:{label:"Mastery",maxLevel:8,baseCost:140,costScale:1.4,outgoingPerLevel:.05,incomingReductionPerLevel:.03}},j={maxLevel:5,hpPerLevel:.1,speedPerLevel:.04,outgoingPerLevel:.06,incomingReductionPerLevel:.025,radiusPerLevel:.6},_={quick_dash:{label:"Quick Dash",description:"Borrows Trickster dash, but weaker.",ability:"dash",cooldown:3.8,dashMultiplier:1.22,hpPenalty:.92,outgoingPenalty:.9},minor_regen:{label:"Minor Regen",description:"Borrows Medic regen, but weaker.",ability:"regen",regenPerSecond:1.8,hpPenalty:.9,outgoingPenalty:.92},blade_echo:{label:"Blade Echo",description:"Borrows Swordsman slash, but weaker.",ability:"sword",slashCooldown:1.75,slashRadius:76,slashDamage:6.5,slashPush:58,hpPenalty:.9,outgoingPenalty:.91},arrow_echo:{label:"Arrow Echo",description:"Borrows Archer shot, but weaker.",ability:"archer",shotCooldown:1.35,shotRange:246,shotDamage:7.2,shotPush:48,hpPenalty:.9,outgoingPenalty:.91}},m=["tank","striker","medic","trickster","sniper","vampire","bulwark","splitter","swordsman","archer","boss"],p={tank:{label:"Tank",description:"Heavy body. Very durable but slower and lower damage.",color:3108827,radius:22,mass:1.65,maxHp:148,speed:175,outgoingDamageMult:.9,incomingDamageMult:.74,wallBounceMult:.9},striker:{label:"Striker",description:"Aggressive burst damage class with high impact attacks.",color:15092540,radius:17,mass:1,maxHp:100,speed:255,outgoingDamageMult:1.24,incomingDamageMult:1.02,wallBounceMult:1},medic:{label:"Medic",description:"Regenerates health over time, excels in long fights.",color:2339950,radius:18,mass:1.05,maxHp:112,speed:210,outgoingDamageMult:1,incomingDamageMult:.95,wallBounceMult:1,regenPerSecond:4.2},trickster:{label:"Trickster",description:"Dashes periodically and gains speed from wall rebounds.",color:15774761,radius:16,mass:.8,maxHp:92,speed:240,outgoingDamageMult:1.06,incomingDamageMult:1.08,wallBounceMult:1.08,dashCooldown:2.8,dashMultiplier:1.45},sniper:{label:"Sniper",description:"Glass cannon. High impact collisions deal extra precision damage.",color:9390079,radius:15,mass:.9,maxHp:88,speed:230,outgoingDamageMult:1.17,incomingDamageMult:1.1,wallBounceMult:1.02,impactThreshold:210,impactBonusMult:1.55},vampire:{label:"Vampire",description:"Lifesteal class. Heals from damage dealt to enemies.",color:9245247,radius:17,mass:1.02,maxHp:105,speed:218,outgoingDamageMult:1.1,incomingDamageMult:1,wallBounceMult:1,lifesteal:.24},bulwark:{label:"Bulwark",description:"Periodic shield and damage reflection (thorns).",color:5534074,radius:20,mass:1.35,maxHp:130,speed:185,outgoingDamageMult:.96,incomingDamageMult:.92,wallBounceMult:.96,shieldCooldown:4.4,shieldDuration:1.2,shieldReductionMult:.5,thorns:.17},splitter:{label:"Splitter",description:"Every heavy hit can split it into two smaller fragments.",color:1292454,radius:16,mass:.86,maxHp:90,speed:230,outgoingDamageMult:.95,incomingDamageMult:1.06,wallBounceMult:1.05,splitImpactThreshold:0,splitCooldown:.24,maxSplitDepth:2,childHpRatio:.52,childRadiusMult:.78,childSpeedMult:1.1},swordsman:{label:"Swordsman",description:"Melee duelist with periodic sword slashes that cut nearby enemies.",color:16347926,radius:18,mass:1.08,maxHp:116,speed:228,outgoingDamageMult:1.08,incomingDamageMult:.98,wallBounceMult:1.02,slashCooldown:1.15,slashRadius:94,slashDamage:10.5,slashPush:74},archer:{label:"Archer",description:"Ranged hunter that periodically shoots the nearest enemy.",color:2278750,radius:16,mass:.92,maxHp:94,speed:238,outgoingDamageMult:1.11,incomingDamageMult:1.05,wallBounceMult:1.03,shotCooldown:.95,shotRange:320,shotDamage:11,shotPush:62},boss:{label:"Boss",description:"Huge elite with shockwave slams, roar pulses, regen, and an enrage phase.",color:14251782,radius:28,mass:2.3,maxHp:320,speed:188,outgoingDamageMult:1.18,incomingDamageMult:.62,wallBounceMult:.9,bonusDamageReduction:.96,regenPerSecond:3.6,shockwaveIntervalSteps:6,shockwavePush:108,shockwaveRecoil:.14,shockwaveCooldown:.35,roarCooldown:1.1,roarRadius:176,roarPush:124,roarDamage:9,chargeCooldown:1.7,chargeForce:122,enrageThreshold:.45,enrageSpeedMult:1.24,enrageOutgoingBonus:.2,enrageIncomingReduction:.11}},X={arenaWidth:980,arenaHeight:640,classCounts:{tank:4,striker:5,medic:3,trickster:4,sniper:3,vampire:3,bulwark:3,splitter:3,swordsman:4,archer:4,boss:1}},$t=[[1,.6],[1,-.6],[-1,.6],[-1,-.6],[.6,1],[-.6,1],[.6,-1],[-.6,-1],[.25,1],[-.25,1]],le=56,g=(r,t,e)=>Math.min(e,Math.max(t,r)),ft=r=>Math.round(r*Lt)/Lt,z=r=>`#${p[r].color.toString(16).padStart(6,"0")}`;function tt(r){const t=Number.parseInt(r,10);return!Number.isFinite(t)||Number.isNaN(t)?0:g(t,0,90)}function I(r,t){const e=Number.parseInt(r,10);return!Number.isFinite(e)||Number.isNaN(e)?t:g(e,420,2200)}function ce(r,t,e=m){const i={};let o=0;for(const c of e){const h=tt(r==null?void 0:r[c]);i[c]=h,o+=h}if(o<=t)return{classCounts:i,total:o,wasCapped:!1};const a={...i},s=[...e].sort((c,h)=>a[h]-a[c]||c.localeCompare(h));let l=o-t;for(const c of s){if(l<=0)break;const h=Math.min(a[c],l);a[c]-=h,l-=h}const n=Object.values(a).reduce((c,h)=>c+h,0);return{classCounts:a,total:n,wasCapped:!0}}function zt(r){return btoa(unescape(encodeURIComponent(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function qt(r){const t=r.replace(/-/g,"+").replace(/_/g,"/"),e=t.length%4===0?"":"=".repeat(4-t.length%4);return decodeURIComponent(escape(atob(t+e)))}function he(r){const t={w:I(r.arenaWidth,X.arenaWidth),h:I(r.arenaHeight,X.arenaHeight),c:m.reduce((e,i)=>(e[i]=tt(r.classCounts[i]),e),{})};return zt(JSON.stringify(t))}function de(r){var t;try{const e=JSON.parse(qt(r));if(!e||typeof e!="object")return null;const i={};for(const o of m)i[o]=tt((t=e.c)==null?void 0:t[o]);return{arenaWidth:I(e.w,X.arenaWidth),arenaHeight:I(e.h,X.arenaHeight),classCounts:i}}catch{return null}}function ue(){const t=new URL(window.location.href).searchParams.get("setup");return t?de(t):null}function pe(){return new URL(window.location.href).searchParams.get("replay")}function fe(r){return zt(JSON.stringify(r))}function me(r){try{const t=JSON.parse(qt(r));return!t||typeof t!="object"?null:t}catch{return null}}function yt(r,t,e,i,o,a){const s=p[t];return{id:r,classKey:t,classLabel:s.label,r:s.radius,mass:s.mass,x:e,y:i,vx:o,vy:a,hp:s.maxHp,maxHp:s.maxHp,color:s.color,alive:!0,abilityState:{tricksterDashTimer:s.dashCooldown??0,bulwarkShieldCooldown:s.shieldCooldown??0,bulwarkShieldTimeLeft:0,splitDepth:0,splitCooldownLeft:0,swordsmanSlashCooldown:s.slashCooldown??0,archerShotCooldown:s.shotCooldown??0,mutationCooldown:0,bossShockwaveCooldown:0,bossRoarCooldown:s.roarCooldown??0,bossChargeCooldown:s.chargeCooldown??0,bossEnraged:!1}}}function ge(r){const t=[];for(const e of m){const i=tt(r[e]);for(let o=0;o<i;o+=1)t.push(e)}return t}function xe(r){const t=ge(r.classCounts),e=t.length;if(e===0)return[];const i=Math.max(1,Math.ceil(Math.sqrt(e*(r.arenaWidth/r.arenaHeight)))),o=Math.max(1,Math.ceil(e/i)),a=Math.max(50,Math.min(130,r.arenaWidth*.12)),s=Math.max(50,Math.min(130,r.arenaHeight*.12)),l=Math.max(0,r.arenaWidth-a*2),n=Math.max(0,r.arenaHeight-s*2),c=[];for(let h=0;h<e;h+=1){const d=t[h],u=p[d],f=h%i,x=Math.floor(h/i),S=i>1?a+l*f/(i-1):r.arenaWidth/2,y=o>1?s+n*x/(o-1):r.arenaHeight/2,[v,T]=$t[h%$t.length],b=Math.hypot(v,T)||1,M=v/b*u.speed,D=T/b*u.speed;c.push(yt(h,d,S,y,M,D))}return c}function ye(r,t){return{minX:Math.floor((r.x-r.r)/t),maxX:Math.floor((r.x+r.r)/t),minY:Math.floor((r.y-r.r)/t),maxY:Math.floor((r.y+r.r)/t)}}function ve(r,t=le){const e=new Map;for(let a=0;a<r.length;a+=1){const s=ye(r[a],t);for(let l=s.minX;l<=s.maxX;l+=1)for(let n=s.minY;n<=s.maxY;n+=1){const c=`${l}:${n}`,h=e.get(c);h?h.push(a):e.set(c,[a])}}const i=new Set,o=[];for(const a of e.values())if(!(a.length<2))for(let s=0;s<a.length;s+=1)for(let l=s+1;l<a.length;l+=1){const n=a[s],c=a[l],h=n<c?`${n}:${c}`:`${c}:${n}`;i.has(h)||(i.add(h),o.push([n,c]))}return o}function Se({a:r,b:t,impact:e,normalX:i,normalY:o,canDealDamage:a}){const s=Math.max(0,r.vx*i+r.vy*o),l=Math.max(0,-(t.vx*i+t.vy*o)),n=g(s/nt*Et,0,Bt),c=g(l/nt*Et,0,Bt);let h=0,d=0;if(a&&e>=ie){const T=g(Qt+te*e,ee,se);h=T*(1+n),d=T*(1+c)}r.classKey==="sniper"&&e>=p.sniper.impactThreshold&&(h*=p.sniper.impactBonusMult),t.classKey==="sniper"&&e>=p.sniper.impactThreshold&&(d*=p.sniper.impactBonusMult),r.classKey==="striker"&&r.hp/r.maxHp<.35&&(h*=1.2),t.classKey==="striker"&&t.hp/t.maxHp<.35&&(d*=1.2);let u=h*p[r.classKey].outgoingDamageMult*p[t.classKey].incomingDamageMult,f=d*p[t.classKey].outgoingDamageMult*p[r.classKey].incomingDamageMult;r.classKey==="bulwark"&&r.abilityState.bulwarkShieldTimeLeft>0&&(f*=p.bulwark.shieldReductionMult),t.classKey==="bulwark"&&t.abilityState.bulwarkShieldTimeLeft>0&&(u*=p.bulwark.shieldReductionMult),r.classKey==="boss"&&(f*=p.boss.bonusDamageReduction),t.classKey==="boss"&&(u*=p.boss.bonusDamageReduction);const x=a&&r.classKey==="vampire"?u*p.vampire.lifesteal:0,S=a&&t.classKey==="vampire"?f*p.vampire.lifesteal:0,y=a&&r.classKey==="bulwark"&&r.abilityState.bulwarkShieldTimeLeft>0?f*p.bulwark.thorns:0,v=a&&t.classKey==="bulwark"&&t.abilityState.bulwarkShieldTimeLeft>0?u*p.bulwark.thorns:0;return a||(f=0,u=0),{damageToA:f,damageToB:u,healingForA:x,healingForB:S,thornsToA:v,thornsToB:y}}const be={balanced:{label:"Balanced",counts:{tank:4,striker:5,medic:3,trickster:4,sniper:3,vampire:3,bulwark:3,splitter:3,swordsman:4,archer:4,boss:1}},chaos:{label:"Chaos",counts:{tank:8,striker:10,medic:6,trickster:8,sniper:8,vampire:8,bulwark:6,splitter:10,swordsman:10,archer:10,boss:3}},duel:{label:"Duel",counts:{tank:0,striker:0,medic:0,trickster:0,sniper:0,vampire:0,bulwark:0,splitter:0,swordsman:1,archer:1,boss:0}}};function we(){if(document.getElementById("ball-controls-style"))return;const r=document.createElement("style");r.id="ball-controls-style",r.textContent=`
    :root {
      --ui-bg: rgba(6, 14, 25, 0.95);
      --ui-edge: #36506e;
      --ui-text: #e2e8f0;
      --ui-muted: #9aa7bb;
      --ui-accent: #f2c94c;
      --ui-accent-alt: #67e8f9;
      --ui-danger: #ff7c70;
    }
    body {
      margin: 0;
      background:
        radial-gradient(1200px 560px at 8% 14%, rgba(24, 43, 73, 0.48), rgba(10, 16, 30, 0.25)),
        linear-gradient(180deg, #0a111f, #0c1424 36%, #090f1b);
    }
    canvas {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    #ball-controls {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 50;
      width: 348px;
      max-height: calc(100vh - 20px);
      overflow: auto;
      background: var(--ui-bg);
      color: var(--ui-text);
      border: 2px solid var(--ui-edge);
      border-radius: 10px;
      padding: 12px;
      font-family: "Consolas", "Cascadia Mono", monospace;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
      user-select: none;
    }
    #ball-controls h2 {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.3px;
      color: var(--ui-accent);
    }
    #ball-controls .intro {
      margin-bottom: 8px;
      border: 1px solid #2c405b;
      border-radius: 7px;
      background: rgba(15, 24, 42, 0.95);
      padding: 8px;
      font-size: 11px;
      line-height: 1.35;
      color: #bed0ea;
    }
    #ball-controls .status {
      margin-bottom: 8px;
      border: 1px solid #2f4d73;
      border-radius: 7px;
      background: linear-gradient(180deg, rgba(16, 34, 59, 0.94), rgba(11, 20, 35, 0.96));
      padding: 8px;
      font-size: 12px;
      line-height: 1.35;
    }
    #ball-controls .status strong {
      color: #f8e389;
    }
    #ball-controls .row {
      display: grid;
      grid-template-columns: 1fr 90px;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    #ball-controls label {
      font-size: 12px;
      opacity: 0.94;
    }
    #ball-controls input,
    #ball-controls select {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #355171;
      border-radius: 5px;
      padding: 5px 6px;
      font-size: 12px;
      background: #0a1426;
      color: #ecf4ff;
      font-family: inherit;
    }
    #ball-controls .actions {
      display: grid;
      margin-top: 8px;
      margin-bottom: 10px;
      gap: 6px;
    }
    #ball-controls .actions.primary {
      grid-template-columns: 1fr 1fr;
    }
    #ball-controls .section {
      margin-bottom: 10px;
      border: 1px solid #2f4d73;
      border-radius: 8px;
      background: rgba(8, 18, 31, 0.78);
      padding: 8px;
    }
    #ball-controls details.section > summary {
      cursor: pointer;
      list-style: none;
      font-size: 12px;
      font-weight: 700;
      color: #9de6ff;
      margin: -2px 0 6px;
    }
    #ball-controls details.section > summary::-webkit-details-marker {
      display: none;
    }
    #ball-controls details.section > summary::before {
      content: "\\25B8 ";
      color: #f4d974;
    }
    #ball-controls details[open].section > summary::before {
      content: "\\25BE ";
    }
    #ball-controls button {
      border: 0;
      border-radius: 6px;
      padding: 8px 9px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
      background: var(--ui-accent);
      color: #111827;
      font-family: inherit;
      transition: transform 120ms ease, filter 120ms ease;
    }
    #ball-controls button:hover {
      filter: brightness(1.04);
      transform: translateY(-1px);
    }
    #ball-controls .preset-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin: 8px 0;
    }
    #ball-controls .preset-row button {
      background: var(--ui-accent-alt);
      color: #0b1a2e;
      padding: 6px 8px;
      font-size: 11px;
    }
    #ball-controls .subsection {
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 700;
      color: #9de6ff;
    }
    #ball-controls .panel {
      margin-bottom: 8px;
      border: 1px solid #2f4d73;
      border-radius: 7px;
      background: rgba(8, 18, 31, 0.8);
      padding: 8px;
      font-size: 11px;
      line-height: 1.35;
      color: #dbeafe;
    }
    #ball-controls .drop-zone {
      min-height: 48px;
      border: 2px dashed #416086;
      border-radius: 8px;
      padding: 6px;
      background: rgba(7, 15, 28, 0.78);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }
    #ball-controls .drop-zone.active {
      border-color: #7cf7eb;
      background: rgba(9, 60, 72, 0.34);
    }
    #ball-controls .chip {
      display: inline-flex;
      align-items: center;
      border: 1px solid #111827;
      border-radius: 12px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 700;
      color: #f8fafc;
      cursor: grab;
      white-space: nowrap;
      touch-action: none;
    }
    #ball-controls .chip.saved {
      cursor: pointer;
      border-color: #e5e7eb;
    }
    #ball-controls .chip.dragging {
      opacity: 0.3;
    }
    #ball-controls .chip-ghost {
      position: fixed;
      left: 0;
      top: 0;
      z-index: 1000;
      pointer-events: none;
      opacity: 0.95;
      transform: translate(-9999px, -9999px);
    }
    #ball-controls .link-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px;
      margin-bottom: 8px;
    }
    #ball-controls .link-row input {
      background: #050b16;
      border-color: #3f5d83;
      font-size: 11px;
    }
    #ball-controls .mini {
      background: #93e9d6;
      color: #12263f;
      padding: 6px 8px;
      font-size: 11px;
    }
    #ball-controls .desc-title {
      margin-top: 6px;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 700;
      color: #f4d974;
    }
    #ball-controls .class-desc {
      margin: 0 0 6px;
      font-size: 11px;
      line-height: 1.35;
      color: #d5deeb;
    }
    #ball-controls .swatch {
      display: inline-block;
      width: 9px;
      height: 9px;
      border: 1px solid #0f172a;
      margin-right: 6px;
      vertical-align: middle;
    }
    #ball-controls .hint {
      margin-top: 8px;
      font-size: 11px;
      color: var(--ui-muted);
      line-height: 1.3;
    }
    #ball-controls textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #355171;
      border-radius: 5px;
      padding: 6px;
      font-size: 11px;
      background: #0a1426;
      color: #ecf4ff;
      font-family: inherit;
      resize: vertical;
      min-height: 54px;
    }
    @media (max-width: 980px) {
      #ball-controls {
        right: 8px;
        left: 8px;
        top: 8px;
        width: auto;
        max-height: calc(100vh - 16px);
      }
    }
  `,document.head.appendChild(r)}function Ce(r){const t=r.getModeLabel?r.getModeLabel(r.mode):r.mode.charAt(0).toUpperCase()+r.mode.slice(1),e=m.reduce((i,o)=>i+(r.setup.classCounts[o]??0),0);return e===0?`[${t}] <strong style="color:var(--ui-danger)">No balls configured.</strong> Set class counts and click Save Setup.`:!r.roundActive&&!r.roundFinished?`[${t}] Ready (${e} configured). Click <strong>Start Round</strong>.`:r.roundFinished?r.winnerClassKey?`[${t}] Winner: <strong style="color:${z(r.winnerClassKey)}">${p[r.winnerClassKey].label}</strong> (${r.balls.length} left)`:`[${t}] <strong>Draw:</strong> no surviving balls`:`[${t}] Round running... alive ${r.balls.length}`}function Dt(r,t,e){return r>=e.left&&r<=e.right&&t>=e.top&&t<=e.bottom}function Me(r,t,e,i){t.draggable=!1,t.addEventListener("pointerdown",o=>{if(!o.isPrimary||o.button!==0&&o.pointerType!=="touch")return;o.preventDefault(),t.setPointerCapture&&t.setPointerCapture(o.pointerId);const a=t.cloneNode(!0);a.classList.add("chip-ghost"),document.body.appendChild(a),t.classList.add("dragging");const s=(d,u)=>{a.style.transform=`translate(${Math.round(d+12)}px, ${Math.round(u+12)}px)`;const f=Dt(d,u,i.getBoundingClientRect());i.classList.toggle("active",f)};s(o.clientX,o.clientY);const l=d=>{s(d.clientX,d.clientY)},n=(d,u)=>{i.classList.remove("active"),t.classList.remove("dragging"),a.remove(),Dt(d,u,i.getBoundingClientRect())&&r.addClassToNextRoundBox(e)},c=d=>{window.removeEventListener("pointermove",l),window.removeEventListener("pointerup",c),window.removeEventListener("pointercancel",h),t.releasePointerCapture&&t.releasePointerCapture(o.pointerId),n(d.clientX,d.clientY)},h=()=>{window.removeEventListener("pointermove",l),window.removeEventListener("pointerup",c),window.removeEventListener("pointercancel",h),t.releasePointerCapture&&t.releasePointerCapture(o.pointerId),i.classList.remove("active"),t.classList.remove("dragging"),a.remove()};window.addEventListener("pointermove",l),window.addEventListener("pointerup",c),window.addEventListener("pointercancel",h)})}function Re(r){we();let t=document.getElementById("ball-controls");t||(t=document.createElement("div"),t.id="ball-controls",document.body.appendChild(t));const e=m.map(w=>`
      <div class="row">
        <label for="count_${w}">${p[w].label}</label>
        <input id="count_${w}" data-class-key="${w}" type="number" min="0" max="90" />
      </div>
    `).join(""),i=m.map(w=>`<p class="class-desc"><span class="swatch" style="background:${z(w)}"></span><strong>${p[w].label}:</strong> ${p[w].description}</p>`).join("");t.innerHTML=`
    <h2>Bouncing Balls Arena</h2>
    <div class="intro">Set your classes and press Start Round. Winners get deterministic auto-rewards each round.</div>
    <div id="roundStatus" class="status">Round running...</div>
    <div class="actions primary">
      <button id="startRoundBtn" type="button">Start Round</button>
      <button id="resetRoundBtn" type="button">Prepare Round</button>
    </div>
    <div class="actions">
      <button id="battleComparisonBtn" type="button" style="background:#67e8f9;color:#0b1a2e">Battle Comparison</button>
    </div>
    <div class="section">
      <div class="row">
        <label for="modeSelect">Mode</label>
        <select id="modeSelect">
          <option value="classic">Sandbox (Bug Fix)</option>
          <option value="blitz">Stress Test (Fast)</option>
          <option value="tournament">Bracket Test (Series)</option>
        </select>
      </div>
      <div class="row">
        <label for="arenaSelect">Arena</label>
        <select id="arenaSelect">
          <option value="standard">Standard</option>
          <option value="crossfire">Crossfire</option>
          <option value="sanctum">Sanctum</option>
          <option value="gauntlet">Gauntlet</option>
        </select>
      </div>
      <div class="row">
        <label for="modifierSelect">Modifier</label>
        <select id="modifierSelect">
          <option value="none">None</option>
          <option value="iron_wall">Iron Wall</option>
          <option value="glass_cannon">Glass Cannon</option>
          <option value="turbo">Turbo</option>
        </select>
      </div>
      <div class="row">
        <label for="speedSelect">Sim Speed</label>
        <select id="speedSelect">
          <option value="1">1x</option>
          <option value="2">2x</option>
          <option value="4">4x</option>
        </select>
      </div>
      <div class="row">
        <label for="arenaWidth">Arena Width</label>
        <input id="arenaWidth" type="number" min="420" max="2200" />
      </div>
      <div class="row">
        <label for="arenaHeight">Arena Height</label>
        <input id="arenaHeight" type="number" min="420" max="2200" />
      </div>
      <div class="preset-row">
        <button id="presetBalanced" type="button">Balanced</button>
        <button id="presetChaos" type="button">Chaos</button>
        <button id="presetDuel" type="button">Duel</button>
      </div>
      <div class="actions">
        <button id="applySetupBtn" type="button">Save Setup</button>
      </div>
    </div>
    <details class="section" open>
      <summary>Class Counts</summary>
      ${e}
    </details>
    <details class="section">
      <summary>Tournament</summary>
      <div class="actions">
        <button id="startTournamentBtn" type="button">Start Tournament</button>
        <button id="startTeamTournamentBtn" type="button">Start Team Tournament</button>
        <button id="stopTournamentBtn" type="button">Stop Tournament</button>
      </div>
      <div id="tournamentStatus" class="panel">Tournament inactive.</div>
    </details>
    <details class="section" open>
      <summary>Progress</summary>
      <div class="subsection">Prize Board</div>
      <div id="prizeBoard" class="panel">No prizes awarded yet.</div>
      <div class="subsection">Round Survivors (drag)</div>
      <div id="survivorPool" class="drop-zone"></div>
      <div class="subsection">Next Round Box (drop here)</div>
      <div id="nextRoundBox" class="drop-zone"></div>
      <div class="actions">
        <button id="useNextRoundBtn" type="button">Use Box For Next Round</button>
      </div>
    </details>
    <details class="section" open>
      <summary>Round Reward</summary>
      <div id="rewardSummary" class="panel">Win a round to trigger a deterministic auto-reward.</div>
      <div id="rewardChoices" class="actions"></div>
    </details>
    <details class="section">
      <summary>Share + Replay</summary>
      <div class="subsection">Share Setup Link</div>
      <div class="link-row">
        <input id="shareLinkOut" type="text" readonly />
        <button id="copyLinkBtn" class="mini" type="button">Copy</button>
      </div>
      <div class="actions">
        <button id="generateLinkBtn" type="button">Generate Link</button>
      </div>
      <div class="subsection">Replay</div>
      <textarea id="replayOut" readonly></textarea>
      <div class="actions">
        <button id="exportReplayBtn" type="button">Export Replay Token</button>
      </div>
      <textarea id="replayIn" placeholder="Paste replay token here"></textarea>
      <div class="actions">
        <button id="importReplayBtn" type="button">Import Replay Token</button>
      </div>
    </details>
    <details class="section">
      <summary>Combat + Class Info</summary>
      <div class="subsection">Combat Log</div>
      <div id="combatLog" class="panel">No combat events yet.</div>
      <div class="subsection">Achievements</div>
      <div id="achievements" class="panel">No achievements yet.</div>
      <div class="desc-title">Class Descriptions</div>
      ${i}
    </details>
    <div class="hint">Controls: S start | R prepare | F fast-forward | P pause | [ slower | ] faster</div>
    <div class="hint">Modes: Sandbox for debugging, Stress Test for fast break checks, Bracket Test for repeated match validation.</div>
    <div class="hint">Flow: Save Setup -> Start Round -> reward auto-applies on win.</div>
  `;const o=t.querySelector("#arenaWidth"),a=t.querySelector("#arenaHeight"),s=t.querySelector("#modeSelect"),l=t.querySelector("#arenaSelect"),n=t.querySelector("#modifierSelect"),c=t.querySelector("#speedSelect"),h=t.querySelector("#roundStatus"),d=t.querySelector("#tournamentStatus"),u=t.querySelector("#prizeBoard"),f=t.querySelector("#rewardSummary"),x=t.querySelector("#rewardChoices"),S=t.querySelector("#combatLog"),y=t.querySelector("#achievements"),v=t.querySelector("#survivorPool"),T=t.querySelector("#nextRoundBox"),b=t.querySelector("#shareLinkOut"),M=t.querySelector("#replayOut"),D=t.querySelector("#replayIn"),q=t.querySelector("#applySetupBtn"),B=t.querySelector("#startRoundBtn"),P=t.querySelector("#resetRoundBtn"),H=t.querySelector("#startTournamentBtn"),K=t.querySelector("#startTeamTournamentBtn"),O=t.querySelector("#stopTournamentBtn"),rt=t.querySelector("#useNextRoundBtn"),Y=t.querySelector("#generateLinkBtn"),lt=t.querySelector("#exportReplayBtn"),A=t.querySelector("#importReplayBtn"),V=t.querySelector("#copyLinkBtn"),ct=t.querySelector("#presetBalanced"),ht=t.querySelector("#presetChaos"),dt=t.querySelector("#presetDuel"),ut=t.querySelector("#battleComparisonBtn"),Z=t.querySelectorAll("[data-class-key]");r.ui={root:t,arenaWidthEl:o,arenaHeightEl:a,modeSelectEl:s,arenaSelectEl:l,modifierSelectEl:n,speedSelectEl:c,roundStatusEl:h,tournamentStatusEl:d,prizeBoardEl:u,rewardSummaryEl:f,rewardChoicesEl:x,combatLogEl:S,achievementsEl:y,survivorPoolEl:v,nextRoundBoxEl:T,shareLinkOutEl:b,replayOutEl:M,replayInEl:D,countInputs:Z,setStatusMessage:w=>{h.innerHTML=w},createStatusHtml:()=>Ce(r),bindDraggableChip:(w,$)=>Me(r,w,$,T)},r.syncControlInputs(),s.value=r.mode,l.value=r.arenaMode,n.value=r.activeModifier,c.value=String(r.speedMultiplier??1);const E=w=>{const $=be[w];if($){for(const J of Z){const Q=J.dataset.classKey;J.value=String($.counts[Q]??0)}r.ui.setStatusMessage(`${r.ui.createStatusHtml()}<br /><strong>${$.label} preset loaded.</strong>`)}};ct.addEventListener("click",()=>E("balanced")),ht.addEventListener("click",()=>E("chaos")),dt.addEventListener("click",()=>E("duel"));const L=()=>{const w={};for(const $ of Z)w[$.dataset.classKey]=tt($.value);r.applySetup({arenaWidth:I(o.value,r.setup.arenaWidth),arenaHeight:I(a.value,r.setup.arenaHeight),classCounts:w})};q.addEventListener("click",()=>{L(),r.syncControlInputs()}),B.addEventListener("click",()=>{L(),r.startRound(),r.syncControlInputs()}),s.addEventListener("change",()=>{r.setMode(s.value),r.syncControlInputs()}),l.addEventListener("change",()=>{r.setArenaMode(l.value),r.syncControlInputs()}),n.addEventListener("change",()=>{r.setModifier(n.value),r.syncControlInputs()}),c.addEventListener("change",()=>{r.setSpeedMultiplier(c.value),r.syncControlInputs()}),P.addEventListener("click",()=>{r.resetSimulation(),r.syncControlInputs()}),ut.addEventListener("click",()=>{r.showBattleComparison()}),H.addEventListener("click",()=>{L(),r.startTournament(!1),r.syncControlInputs()}),K.addEventListener("click",()=>{L(),r.startTournament(!0),r.syncControlInputs()}),O.addEventListener("click",()=>{r.stopTournament(),r.syncControlInputs()}),rt.addEventListener("click",()=>{r.applyNextRoundBox(),r.syncControlInputs()}),Y.addEventListener("click",()=>{b.value=r.generateShareLink(),b.select()}),lt.addEventListener("click",()=>{M.value=r.exportReplayToken(),M.select()}),A.addEventListener("click",()=>{const w=D.value.trim();if(!w){r.ui.setStatusMessage(`${r.ui.createStatusHtml()}<br /><strong>Paste a replay token first.</strong>`);return}r.importReplayToken(w)?(M.value=w,r.ui.setStatusMessage(`${r.ui.createStatusHtml()}<br /><strong>Replay imported.</strong>`)):r.ui.setStatusMessage(`${r.ui.createStatusHtml()}<br /><strong>Replay import failed.</strong>`)}),V.addEventListener("click",async()=>{b.value||(b.value=r.generateShareLink());try{await navigator.clipboard.writeText(b.value),r.ui.setStatusMessage(`${r.ui.createStatusHtml()}<br /><strong>Link copied.</strong>`)}catch{b.select(),b.setSelectionRange(0,b.value.length),r.ui.setStatusMessage(`${r.ui.createStatusHtml()}<br /><strong>Copy failed, selected URL for manual copy.</strong>`)}}),r.updateRoundPanels()}const at=5,mt=7,ke={A:[4,10,17,31,17,17,17],B:[30,17,17,30,17,17,30],C:[14,17,16,16,16,17,14],D:[30,17,17,17,17,17,30],E:[31,16,16,30,16,16,31],F:[31,16,16,30,16,16,16],G:[14,17,16,23,17,17,15],H:[17,17,17,31,17,17,17],I:[14,4,4,4,4,4,14],J:[7,2,2,2,2,18,12],K:[17,18,20,24,20,18,17],L:[16,16,16,16,16,16,31],M:[17,27,21,21,17,17,17],N:[17,25,21,19,17,17,17],O:[14,17,17,17,17,17,14],P:[30,17,17,30,16,16,16],Q:[14,17,17,17,21,18,13],R:[30,17,17,30,20,18,17],S:[14,17,16,14,1,17,14],T:[31,4,4,4,4,4,4],U:[17,17,17,17,17,17,14],V:[17,17,17,17,10,10,4],W:[17,17,17,21,21,27,17],X:[17,17,10,4,10,17,17],Y:[17,17,10,4,4,4,4],Z:[31,1,2,4,8,16,31],0:[14,17,19,21,25,17,14],1:[4,12,4,4,4,4,14],2:[14,17,1,6,8,16,31],3:[14,17,1,6,1,17,14],4:[2,6,10,18,31,2,2],5:[31,16,30,1,1,17,14],6:[6,8,16,30,17,17,14],7:[31,1,2,4,8,8,8],8:[14,17,17,14,17,17,14],9:[14,17,17,15,1,2,12]," ":[0,0,0,0,0,0,0],":":[0,4,4,0,4,4,0],".":[0,0,0,0,0,0,4],"+":[0,4,4,31,4,4,0],"-":[0,0,0,31,0,0,0],"/":[1,1,2,4,8,16,16],"%":[25,25,2,4,8,19,19],"(":[2,4,8,8,8,4,2],")":[8,4,2,2,2,4,8],"!":[4,4,4,4,4,0,4],"#":[10,10,31,10,31,10,10]},Te={0:null,1:"#111111",2:"#b0b0b0",3:"#d8d8d8",4:"#808080",5:"#8B4513",6:"#A0522D",7:"#f44",8:"#ff0",9:"#44f",a:"#22cc55",b:"#9944ff",c:"#ff8800",d:"#5eead4",e:"#888",f:"#ffcc00"},Gt=["0000000000000010","0000000000000110","0000000000001310","0000000000013310","0000000000132100","0000000001321000","0000000013210000","0000000132100000","0000001321000000","0000013210000000","0000132100000000","0001321000000000","0001214000000000","0000155000000000","0000051000000000","0000001000000000"],vt=["0000000000001000","0000000000011100","0000000000132100","0000000001321000","0000000013210000","0000000132100000","0000001321000000","0000001241000000","0000001551000000","0000000510000000","0000000100000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],Le=["0000001000000000","0000010100000000","0000100010000000","0001000001000000","0010000000100000","0100000000010000","1000000000010000","1000000000010000","1000000000010000","0100000000010000","0010000000100000","0001000001000000","0000100010000000","0000010100000000","0000001000000000","0000000000000000"],It=["0000111111110000","0001999999991000","0019999999999100","0199993339999100","0199933339999100","1999933339999910","1999933339999910","1999933339999910","1999933339999910","0199993339999100","0199999999999100","0019999999999100","0001999999991000","0000199999910000","0000019999100000","0000001110000000"],Ee=["000000aaa0000000","00000a1a1a000000","000000aaa0000000","0000001100000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000006600000000","0000001100000000"],Kt=["0000000000000000","0000000111100000","0000001e44410000","0000014e44100000","000001444e100000","000000141e000000","0000001110000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000005500000000","0000006600000000","0000001100000000"],Be=["0000000000000000","0000100000010000","0001710000171000","0017171001717100","0171717117171710","0171777777171710","0017177717171100","0001177711711000","0000117711100000","0000011710000000","0000011110000000","0000001710000000","0000001100000000","0000001100000000","0000000000000000","0000000000000000"],Pe=["0000000000000000","00f0000f0000f000","00f0000f0000f000","0ff000fff000ff00","0ff000fff000ff00","0fff0fffff0fff00","0fffffffffffff00","01fffffffffff100","01f888f888f88100","01fffffffffff100","0111111111111100","0000000000000000","0000000000000000","0000000000000000","0000000000000000","0000000000000000"],Wt={swordsman:Gt,striker:Kt,tank:It,medic:Ee,archer:Le,vampire:Be,boss:Pe,sniper:vt,trickster:vt,bulwark:It,splitter:Kt},_t={swordsman:"SWORD",striker:"AXE",tank:"SHIELD",medic:"STAFF",archer:"BOW",vampire:"FANGS",boss:"CROWN",sniper:"DAGGER",trickster:"DAGGER",bulwark:"SHIELD",splitter:"AXE"};function Ot(r){const t=p[r];if(!t)return null;const e=Math.round(t.outgoingDamageMult*10),i=t.slashCooldown?Math.round(10/t.slashCooldown):t.shotCooldown?Math.round(10/t.shotCooldown):Math.round(t.speed/25);return{hp:t.maxHp,damage:e,attackSpeed:i,speed:t.speed,defense:Math.round((1-t.incomingDamageMult)*100+(1/t.incomingDamageMult-1)*10)}}function N(r,t,e,i,o,a,s){const l=String(t).toUpperCase();let n=e;for(let c=0;c<l.length;c++){const h=l[c],d=ke[h];if(!d){n+=(at+1)*o;continue}for(let u=0;u<mt;u++){const f=d[u];for(let x=0;x<at;x++)if(f&1<<at-1-x){const S=n+x*o,y=i+u*o;s&&(r.fillStyle=s,r.fillRect(S-o,y,o,o),r.fillRect(S+o,y,o,o),r.fillRect(S,y-o,o,o),r.fillRect(S,y+o,o,o)),r.fillStyle=a,r.fillRect(S,y,o,o)}}n+=(at+1)*o}}function U(r,t){return String(r).toUpperCase().length*(at+1)*t-t}function Ft(r,t,e,i,o,a){const s=t.length,l=t[0].length;for(let n=0;n<s;n++)for(let c=0;c<l;c++){const h=t[n][a?l-1-c:c];if(h==="0")continue;const d=Te[h];d&&(r.fillStyle=d,r.fillRect(e+c*o,i+n*o,o,o))}}function Nt(r,t,e,i,o,a,s){const l=i;for(let h=-l;h<=l;h++)for(let d=-l;d<=l;d++)if(d*d+h*h<=l*l){const u=d*d+h*h>(l-2)*(l-2);r.fillStyle=u?"#111111":a,r.fillRect(t+d*s,e+h*s,s,s)}const n=String(Math.round(o)),c=U(n,s);N(r,n,t-Math.floor(c/2),e-3*s,s,"#ffffff","#111111")}function He(r,t,e,i,o){const a=[[-3,-5],[4,-4],[-5,2],[3,5],[6,-1],[-2,-7],[7,3],[-6,-3],[5,6],[-4,4]];for(let s=0;s<a.length;s++){const l=(i*3+s*.7)%2;if(l>1)continue;const n=1-l,c=l*4,h=a[s][0]*c,d=a[s][1]*c;r.globalAlpha=n,r.fillStyle=s%2===0?"#ffff44":"#ffffff",r.fillRect(t+h*o,e+d*o,o*2,o*2)}r.globalAlpha=1}class Ae{constructor(){this.canvas=null,this.ctx=null,this.visible=!1,this.leftClass="swordsman",this.rightClass="archer",this.animTime=0,this.animFrame=null,this.onClose=null,this._boundAnimate=this._animate.bind(this),this._boundHandleClick=this._handleClick.bind(this),this._boundHandleKey=this._handleKey.bind(this)}init(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.id="battle-comparison-canvas",this.canvas.style.cssText=`
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 100; cursor: pointer; display: none;
      image-rendering: pixelated; image-rendering: crisp-edges;
    `,document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.canvas.addEventListener("click",this._boundHandleClick),window.addEventListener("keydown",this._boundHandleKey))}show(t,e,i){this.init(),this.leftClass=t||"swordsman",this.rightClass=e||"archer",this.onClose=i||null,this.animTime=0,this.visible=!0,this.canvas.style.display="block",this._resize(),this._startAnim()}hide(){if(this.visible=!1,this.canvas&&(this.canvas.style.display="none"),this._stopAnim(),this.onClose){const t=this.onClose;this.onClose=null,t()}}_handleClick(){this.visible&&this.hide()}_handleKey(t){this.visible&&(t.key==="Escape"||t.key===" "||t.key==="Enter")&&(t.preventDefault(),this.hide())}_resize(){const t=window.devicePixelRatio||1;this.canvas.width=Math.floor(window.innerWidth*t),this.canvas.height=Math.floor(window.innerHeight*t),this.ctx.imageSmoothingEnabled=!1}_startAnim(){if(this.animFrame)return;let t=performance.now();const e=i=>{if(!this.visible)return;const o=Math.min((i-t)/1e3,.1);t=i,this.animTime+=o,this._draw(),this.animFrame=requestAnimationFrame(e)};this.animFrame=requestAnimationFrame(e)}_stopAnim(){this.animFrame&&(cancelAnimationFrame(this.animFrame),this.animFrame=null)}_draw(){var Ct,Mt;const t=this.ctx,e=this.canvas.width,i=this.canvas.height,o=this.animTime,s=Math.max(1,Math.min(Math.floor(e/480),Math.floor(i/360)));t.imageSmoothingEnabled=!1,t.fillStyle="#e8dcc8",t.fillRect(0,0,e,i),t.fillStyle="#d8ccb8";for(let C=0;C<i;C+=8*s)for(let k=0;k<e;k+=8*s)(Math.floor(k/(8*s))+Math.floor(C/(8*s)))%2===0&&t.fillRect(k,C,8*s,8*s);const l=Math.min(e-40*s,420*s),n=Math.min(i-100*s,260*s),c=Math.floor((e-l)/2),h=Math.floor((i-n)/2)+10*s,d=4*s;t.fillStyle="#111111",t.fillRect(c-d,h-d,l+d*2,n+d*2),t.fillStyle="#f4f0ec",t.fillRect(c,h,l,n),t.fillStyle="#eae6e0";for(let C=h;C<h+n;C+=6*s)for(let k=c;k<c+l;k+=6*s)(Math.floor((k-c)/(6*s))+Math.floor((C-h)/(6*s)))%2===0&&t.fillRect(k,C,6*s,6*s);const u=p[this.leftClass],f=p[this.rightClass],x=_t[this.leftClass]||((Ct=u==null?void 0:u.label)==null?void 0:Ct.toUpperCase())||"???",S=_t[this.rightClass]||((Mt=f==null?void 0:f.label)==null?void 0:Mt.toUpperCase())||"???",y=`${x} VS ${S}`,v=Math.max(2,s*2),T=U(y,v),b=Math.floor((e-T)/2),M=h-d-18*s;N(t,y,b,M,v,"#222222","#c8bca8");const D=`${(u==null?void 0:u.label)||"???"} VS ${(f==null?void 0:f.label)||"???"}`,q=Math.max(1,s),B=U(D,q);N(t,D,Math.floor((e-B)/2),M+mt*v+4*s,q,"#555544",null);const P=Wt[this.leftClass]||Gt,H=Wt[this.rightClass]||vt,K=Math.max(2,s*2),O=16*K,rt=16*K,Y=Math.min(1,o*2),lt=1-Math.pow(1-Y,3),A=c+Math.floor(l/2),V=h+Math.floor(n/2),ct=Math.floor(l*.18),ht=A-ct-O+Math.floor((1-lt)*-60*s),dt=V-Math.floor(rt/2)+Math.floor(Math.sin(o*2)*3*s),ut=A+ct+Math.floor((1-lt)*60*s),Z=V-Math.floor(rt/2)+Math.floor(Math.sin(o*2+1)*3*s);if(Ft(t,P,ht,dt,K,!1),Ft(t,H,ut,Z,K,!0),Y>=.8&&He(t,A,V,o,s),Y>=.5){const C=Math.min(1,(Y-.5)*4);t.globalAlpha=C;const k=Math.max(3,s*3),G=U("VS",k);N(t,"VS",A-Math.floor(G/2),V-Math.floor(mt*k/2),k,"#cc2222","#111111"),t.globalAlpha=1}const E=Ot(this.leftClass),L=Ot(this.rightClass),w=Math.max(8,10),$=Math.max(1,s);if(E){const C=u?`#${u.color.toString(16).padStart(6,"0")}`:"#cc4444";Nt(t,ht+Math.floor(O/2),dt-12*s,w,E.hp,C,$)}if(L){const C=f?`#${f.color.toString(16).padStart(6,"0")}`:"#44cc44";Nt(t,ut+Math.floor(O/2),Z-12*s,w,L.hp,C,$)}const J=h+n+d+8*s,Q=Math.max(2,Math.floor(s*1.5));if(E){const C=`DAMAGE: ${E.damage}`;N(t,C,c,J,Q,"#cc2222","#111111")}if(L){const C=`ATK SPD: ${L.attackSpeed}`,k=U(C,Q);N(t,C,c+l-k,J,Q,"#22aa44","#111111")}const jt=J+mt*Q+8*s,et=4*s,st=Math.floor((l-20*s)/2);if(E&&L){const C=[{label:"HP",left:E.hp,right:L.hp,color:"#cc3333"},{label:"DMG",left:E.damage,right:L.damage,color:"#cc8822"},{label:"SPD",left:E.speed,right:L.speed,color:"#2288cc"}];for(let k=0;k<C.length;k++){const G=jt+k*(et+6*s),F=C[k],Rt=Math.max(F.left,F.right,1),kt=Math.max(1,s);N(t,F.label,A-Math.floor(U(F.label,kt)/2),G,kt,"#444433",null);const Tt=Math.floor(F.left/Rt*st*Math.min(1,o));t.fillStyle="#222222",t.fillRect(A-14*s-st,G,st,et),t.fillStyle=F.color,t.fillRect(A-14*s-Tt,G+s,Tt,et-2*s);const Yt=Math.floor(F.right/Rt*st*Math.min(1,o));t.fillStyle="#222222",t.fillRect(A+14*s,G,st,et),t.fillStyle=F.color,t.fillRect(A+14*s,G+s,Yt,et-2*s)}}const bt=Math.max(1,s),wt="CLICK OR PRESS SPACE TO START",Ut=U(wt,bt),Xt=.5+.5*Math.sin(o*3);t.globalAlpha=Xt,N(t,wt,Math.floor((e-Ut)/2),i-16*s,bt,"#666655",null),t.globalAlpha=1}destroy(){this._stopAnim(),this.canvas&&(this.canvas.removeEventListener("click",this._boundHandleClick),window.removeEventListener("keydown",this._boundHandleKey),this.canvas.remove(),this.canvas=null,this.ctx=null)}}let xt=null;function $e(){return xt||(xt=new Ae),xt}function De(r){var e;if((e=r.tournament)!=null&&e.active&&r.tournament.currentMatchIndex>=0){const i=r.tournament.matches[r.tournament.currentMatchIndex];if(i){if(i.a&&i.b)return[i.a,i.b];if(i.aTeam&&i.bTeam)return[i.aTeam[0],i.bTeam[0]]}}const t=m.filter(i=>{var o;return(((o=r.setup)==null?void 0:o.classCounts[i])??0)>0}).sort((i,o)=>(r.setup.classCounts[o]??0)-(r.setup.classCounts[i]??0));return t.length>=2?[t[0],t[1]]:t.length===1?[t[0],t[0]]:["swordsman","archer"]}const St=ue()??structuredClone(X),Ie=pe();class Ke extends R.Scene{constructor(){super("main"),this.graphics=null,this.hudText=null,this.winnerText=null,this.accumulator=0,this.stepCounter=0,this.fastForward=!1,this.paused=!1,this.initialState=[],this.balls=[],this.setup=structuredClone(St),this.effects=[],this.simTime=0,this.lastDamageTimesByPair=new Map,this.lastPairPruneAt=0,this.roundFinished=!1,this.roundActive=!1,this.winnerClassKey=null,this.nextRoundBoxClasses=[],this.ui=null,this.pixelMaskCache=new Map,this.nextBallId=0,this.mode="classic",this.arenaMode="standard",this.activeModifier="none",this.prizeLedger=Object.fromEntries(m.map(t=>[t,0])),this.roundWins=Object.fromEntries(m.map(t=>[t,0])),this.upgrades=Object.fromEntries(m.map(t=>[t,{hp:0,speed:0,mastery:0}])),this.evolutionLevels=Object.fromEntries(m.map(t=>[t,0])),this.mutations=Object.fromEntries(m.map(t=>[t,null])),this.lastRewardResult=null,this.battleHistory=[],this.combatLog=[],this.achievements=new Set,this.lastNonEmptyClassSnapshot=Object.fromEntries(m.map(t=>[t,0])),this.textureCacheByKey=new Set,this.classGlyphCache=new Map,this.pendingReplayToken=Ie,this.speedMultiplier=1,this.setupWarningMessage="",this.lastShareLink="",this.tournament={active:!1,teamMode:!1,baseSetup:null,matches:[],currentMatchIndex:-1,standings:Object.fromEntries(m.map(t=>[t,{played:0,wins:0,losses:0}]))}}create(){this.cameras.main.setBackgroundColor(1711398),this.graphics=this.add.graphics(),this.hudText=this.add.text(12,12,"",{fontFamily:"Consolas, monospace",fontSize:"15px",color:"#f3f4f6"}),this.hudText.setDepth(10),this.winnerText=this.add.text(0,0,"",{fontFamily:"Consolas, monospace",fontSize:"26px",color:"#f8fafc",fontStyle:"bold"}),this.winnerText.setDepth(12),this.winnerText.setOrigin(.5,.5),this.winnerText.setVisible(!1),this.input.keyboard.on("keydown-R",()=>{this.resetSimulation()}),this.input.keyboard.on("keydown-S",()=>{this.applySetupFromUiInputs(),this.startRound(!0)}),this.input.keyboard.on("keydown-F",()=>{this.fastForward=!this.fastForward}),this.input.keyboard.on("keydown-P",()=>{this.paused=!this.paused}),this.input.keyboard.on("keydown",t=>{t.key==="]"?this.setSpeedMultiplier(this.speedMultiplier===4?4:this.speedMultiplier*2):t.key==="["&&this.setSpeedMultiplier(this.speedMultiplier===1?1:this.speedMultiplier/2)}),Re(this),this.pendingReplayToken?this.importReplayToken(this.pendingReplayToken,!0)||this.rebuildInitialState():this.rebuildInitialState()}applySetupFromUiInputs(){var e,i,o;if(!((e=this.ui)!=null&&e.countInputs)||this.roundActive)return;const t={};for(const a of this.ui.countInputs)t[a.dataset.classKey]=tt(a.value);this.applySetup({arenaWidth:I((i=this.ui.arenaWidthEl)==null?void 0:i.value,this.setup.arenaWidth),arenaHeight:I((o=this.ui.arenaHeightEl)==null?void 0:o.value,this.setup.arenaHeight),classCounts:t})}syncControlInputs(){if(this.ui){this.ui.arenaWidthEl.value=String(this.setup.arenaWidth),this.ui.arenaHeightEl.value=String(this.setup.arenaHeight),this.ui.modeSelectEl&&(this.ui.modeSelectEl.value=this.mode),this.ui.arenaSelectEl&&(this.ui.arenaSelectEl.value=this.arenaMode),this.ui.modifierSelectEl&&(this.ui.modifierSelectEl.value=this.activeModifier),this.ui.speedSelectEl&&(this.ui.speedSelectEl.value=String(this.speedMultiplier));for(const t of this.ui.countInputs)t.value=String(this.setup.classCounts[t.dataset.classKey]??0)}}setMode(t){["classic","blitz","tournament"].includes(t)&&(this.mode=t,t!=="tournament"&&this.tournament.active&&this.stopTournament(),this.updateRoundPanels())}getModeLabel(t=this.mode){return t==="blitz"?"Stress Test":t==="tournament"?"Bracket Test":"Sandbox"}setArenaMode(t){Ht.includes(t)&&(this.arenaMode=t,this.updateRoundPanels())}setModifier(t){At.includes(t)&&(this.activeModifier=t,this.updateRoundPanels())}setSpeedMultiplier(t){const e=Number(t);[1,2,4].includes(e)&&(this.speedMultiplier=e,this.updateRoundPanels())}getModeRules(){let t=1,e=1,i=1;return this.mode==="blitz"&&(t=1.1,e=1.15,i=1.2),this.mode==="tournament"&&(e=1.05,i=1.25),this.activeModifier==="iron_wall"?(e*=.9,i*=1.05):this.activeModifier==="glass_cannon"?(e*=1.18,i*=1.1):this.activeModifier==="turbo"&&(t*=1.15,i*=1.08),{movementMult:t,damageMult:e,prizeMult:i}}getArenaRules(){return this.arenaMode==="crossfire"?{hazardTick:54,hazardDamage:3.5}:this.arenaMode==="sanctum"?{sanctumRadius:Math.min(this.setup.arenaWidth,this.setup.arenaHeight)*.17,sanctumHealingPerSecond:2.8}:this.arenaMode==="gauntlet"?{wallThorns:7.5}:{}}logCombatEvent(t){this.combatLog.unshift(`t${this.stepCounter}: ${t}`),this.combatLog.length>20&&(this.combatLog=this.combatLog.slice(0,20))}getBattlePrizeAmount(){const t=this.getModeRules(),e=this.balls.reduce((a,s)=>a+s.hp,0),i=Math.round(e*.15),o=Math.max(0,40-Math.floor(this.stepCounter/60));return Math.max(25,Math.round((85+i+o)*t.prizeMult))}awardWinnerPrize(t,e){this.prizeLedger[t]+=e,this.roundWins[t]+=1,this.battleHistory.unshift({id:this.stepCounter+this.simTime,mode:this.mode,winner:t,prize:e,step:this.stepCounter}),this.battleHistory.length>14&&(this.battleHistory=this.battleHistory.slice(0,14)),this.logCombatEvent(`${p[t].label} earned ${e} prize`),this.evaluateAchievements()}getDeterministicValue(t,e=0){const o=t.split("").reduce((a,s)=>a+s.charCodeAt(0),0)+Math.floor(this.simTime*1e3)+this.stepCounter*17+this.balls.length*13+this.battleHistory.length*29+e*41;return Math.abs(o)}pickDeterministicRoundReward(t){const e=["stat","mutation","evolution"],i=["hp","speed","mastery"],o=this.upgrades[t],a=i.filter(d=>o[d]<W[d].maxLevel),l=!!!this.mutations[t],n=(this.evolutionLevels[t]??0)<j.maxLevel,c=e.filter(d=>d==="stat"?a.length>0:d==="mutation"?l:n);if(c.length===0)return null;let h=e[this.getDeterministicValue(t,0)%e.length];if(c.includes(h)||(h=c[this.getDeterministicValue(t,1)%c.length]),h==="stat")return{type:"stat",statKey:a[this.getDeterministicValue(t,2)%a.length]};if(h==="mutation"){const d=Object.keys(_);return{type:"mutation",mutationKey:d[this.getDeterministicValue(t,3)%d.length]}}return{type:"evolution"}}applyRoundReward(t){const e=this.pickDeterministicRoundReward(t);if(!e){this.lastRewardResult={classKey:t,label:`${p[t].label}: no reward available`};return}e.type==="stat"?(this.upgrades[t][e.statKey]+=1,this.lastRewardResult={classKey:t,type:"stat",label:`${p[t].label} auto-reward: +${W[e.statKey].label} (Lv${this.upgrades[t][e.statKey]})`}):e.type==="mutation"?(this.mutations[t]=e.mutationKey,this.lastRewardResult={classKey:t,type:"mutation",label:`${p[t].label} auto-reward: mutation ${_[e.mutationKey].label}`}):(this.evolutionLevels[t]+=1,this.lastRewardResult={classKey:t,type:"evolution",label:`${p[t].label} auto-reward: evolution Lv${this.evolutionLevels[t]}`}),this.logCombatEvent(this.lastRewardResult.label)}applyUpgradesToBall(t){const e=this.upgrades[t.classKey];if(!e)return;const i=e.hp??0,o=e.speed??0,a=e.mastery??0;if(i>0&&(t.maxHp=t.maxHp*(1+i*W.hp.hpPerLevel),t.hp=t.maxHp),o>0){const n=1+o*W.speed.speedPerLevel;t.vx*=n,t.vy*=n}a>0&&(t.outgoingBonus=a*W.mastery.outgoingPerLevel,t.incomingReduction=a*W.mastery.incomingReductionPerLevel);const s=this.evolutionLevels[t.classKey]??0;if(s>0){t.maxHp*=1+s*j.hpPerLevel,t.hp=t.maxHp;const n=1+s*j.speedPerLevel;t.vx*=n,t.vy*=n,t.r=Math.round(t.r+s*j.radiusPerLevel),t.outgoingBonus=(t.outgoingBonus??0)+s*j.outgoingPerLevel,t.incomingReduction=g((t.incomingReduction??0)+s*j.incomingReductionPerLevel,0,.75)}const l=this.mutations[t.classKey];if(l&&_[l]){const n=_[l];t.mutationKey=l,t.maxHp*=n.hpPenalty??.92,t.hp=Math.min(t.hp,t.maxHp),t.outgoingBonus=(t.outgoingBonus??0)-(1-(n.outgoingPenalty??.9)),n.ability==="dash"&&(t.abilityState.mutationCooldown=n.cooldown??3.8),n.ability==="sword"&&(t.abilityState.swordsmanSlashCooldown=n.slashCooldown??1.75),n.ability==="archer"&&(t.abilityState.archerShotCooldown=n.shotCooldown??1.35)}else t.mutationKey=null}exportReplayToken(){const t={v:1,mode:this.mode,arenaMode:this.arenaMode,activeModifier:this.activeModifier,setup:this.setup,upgrades:this.upgrades,evolutionLevels:this.evolutionLevels,mutations:this.mutations,roundWins:this.roundWins};return fe(t)}importReplayToken(t,e=!1){const i=me(t);if(!i||i.v!==1||!i.setup)return!1;if(this.mode=["classic","blitz","tournament"].includes(i.mode)?i.mode:"classic",this.arenaMode=Ht.includes(i.arenaMode)?i.arenaMode:"standard",this.activeModifier=At.includes(i.activeModifier)?i.activeModifier:"none",i.upgrades&&typeof i.upgrades=="object")for(const o of m){const a=i.upgrades[o];a&&(this.upgrades[o]={hp:g(Number(a.hp)||0,0,W.hp.maxLevel),speed:g(Number(a.speed)||0,0,W.speed.maxLevel),mastery:g(Number(a.mastery)||0,0,W.mastery.maxLevel)})}if(i.evolutionLevels&&typeof i.evolutionLevels=="object")for(const o of m){const a=Number(i.evolutionLevels[o])||0;this.evolutionLevels[o]=g(a,0,j.maxLevel)}if(i.mutations&&typeof i.mutations=="object")for(const o of m){const a=i.mutations[o];this.mutations[o]=_[a]?a:null}if(i.roundWins&&typeof i.roundWins=="object")for(const o of m)this.roundWins[o]=Number(i.roundWins[o])||0;return this.applySetup(i.setup),this.syncControlInputs(),e||this.logCombatEvent("Replay imported"),!0}evaluateAchievements(){for(const t of m)(this.prizeLedger[t]??0)>=500&&!this.achievements.has(`rich_${t}`)&&this.achievements.add(`rich_${t}`);this.battleHistory.length>=5&&!this.achievements.has("veteran_5")&&this.achievements.add("veteran_5"),this.mode==="tournament"&&this.battleHistory.length>=10&&!this.achievements.has("tournament_runner")&&this.achievements.add("tournament_runner")}resolveEmptyBattleWinner(){let t=null,e=-1;for(const i of m){const o=this.lastNonEmptyClassSnapshot[i]??0;o>e&&(e=o,t=i)}return e<=0?null:t}getCurrentClassCounts(){const t=Object.fromEntries(m.map(e=>[e,0]));for(const e of this.balls)t[e.classKey]+=1;return t}evaluateWinnerState(){if(this.roundFinished||!this.roundActive)return;if(this.balls.length===0){this.roundFinished=!0,this.roundActive=!1,this.winnerClassKey=this.resolveEmptyBattleWinner(),this.paused=!0,this.finalizeBattleResults(),this.updateRoundPanels();return}new Set(this.balls.map(e=>e.classKey)).size<=1&&(this.roundFinished=!0,this.roundActive=!1,this.winnerClassKey=this.balls[0].classKey,this.paused=!0,this.effects.push({type:"ring",x:this.balls[0].x,y:this.balls[0].y,color:this.balls[0].color,life:.7,radius:this.balls[0].r+6}),this.finalizeBattleResults(),this.updateRoundPanels())}finalizeBattleResults(){if(!this.winnerClassKey)return;const t=this.getBattlePrizeAmount();this.awardWinnerPrize(this.winnerClassKey,t),this.applyRoundReward(this.winnerClassKey),this.tournament.active&&this.completeTournamentBattle(this.winnerClassKey)}getSurvivorDraftPool(){return this.roundFinished?[...this.balls].sort((t,e)=>e.hp-t.hp||t.id-e.id).map(t=>({id:t.id,classKey:t.classKey,label:`${p[t.classKey].label} #${t.id} (${Math.round(t.hp)})`})):[]}getPrizeBoardHtml(){return[...m].map(i=>({classKey:i,prize:this.prizeLedger[i],wins:this.roundWins[i]})).sort((i,o)=>o.wins-i.wins||o.prize-i.prize||m.indexOf(i.classKey)-m.indexOf(o.classKey)).slice(0,6).map(i=>`<div><strong style="color:${z(i.classKey)}">${p[i.classKey].label}</strong>: ${i.wins} wins, ${i.prize} score</div>`).join("")||"<div>No prizes awarded yet.</div>"}getTournamentHtml(){if(!this.tournament.active)return"<div>Tournament inactive.</div>";const t=this.tournament.matches.length,e=this.tournament.currentMatchIndex+1,i=m.filter(l=>{var n;return(((n=this.tournament.baseSetup)==null?void 0:n.classCounts[l])??0)>0}).map(l=>{const n=this.tournament.standings[l];return`<div><strong style="color:${z(l)}">${p[l].label}</strong>: ${n.wins}W-${n.losses}L</div>`}).join(""),o=this.tournament.matches[this.tournament.currentMatchIndex],a=o!=null&&o.label?`<div>${o.label}</div>`:"";return`<div>${this.tournament.teamMode?"Team mode":"Solo mode"} | Match ${e}/${t}</div>${a}${i}`}getCombatLogHtml(){return this.combatLog.length===0?"<div>No combat events yet.</div>":this.combatLog.slice(0,10).map(t=>`<div>${t}</div>`).join("")}getAchievementsHtml(){return this.achievements.size===0?"<div>No achievements yet.</div>":[...this.achievements].slice(0,10).map(t=>`<div>${t}</div>`).join("")}getRewardSummaryHtml(){if(!this.lastRewardResult)return"<div>Win a round to trigger deterministic auto-rewards.</div>";const t=this.lastRewardResult.classKey,e=this.upgrades[t],i=this.evolutionLevels[t]??0,o=this.mutations[t],a=o?_[o].label:"None";return`
      <div><strong style="color:${z(t)}">${p[t].label}</strong></div>
      <div>${this.lastRewardResult.label}</div>
      <div>Stats: HP Lv${e.hp} | Speed Lv${e.speed} | Mastery Lv${e.mastery}</div>
      <div>Evolution Lv${i} | Mutation: ${a}</div>
    `}addClassToNextRoundBox(t){!p[t]||this.nextRoundBoxClasses.length>=90||(this.nextRoundBoxClasses.push(t),this.updateRoundPanels())}applyNextRoundBox(){if(this.nextRoundBoxClasses.length===0)return;const t=Object.fromEntries(m.map(e=>[e,0]));for(const e of this.nextRoundBoxClasses)t[e]+=1;this.nextRoundBoxClasses=[],this.applySetup({arenaWidth:this.setup.arenaWidth,arenaHeight:this.setup.arenaHeight,classCounts:t}),this.updateRoundPanels()}buildTournamentMatches(){const t=m.filter(i=>(this.setup.classCounts[i]??0)>0),e=[];if(this.tournament.teamMode){const i=[];for(let o=0;o<t.length;o+=2){const a=t[o],s=t[o+1];a&&s&&i.push([a,s])}for(let o=0;o<i.length;o+=1)for(let a=o+1;a<i.length;a+=1)e.push({aTeam:i[o],bTeam:i[a],label:`${p[i[o][0]].label}/${p[i[o][1]].label} vs ${p[i[a][0]].label}/${p[i[a][1]].label}`});return e}for(let i=0;i<t.length;i+=1)for(let o=i+1;o<t.length;o+=1)e.push({a:t[i],b:t[o],label:`${p[t[i]].label} vs ${p[t[o]].label}`});return e}startTournament(t=!1){this.tournament.teamMode=!!t;const e=this.buildTournamentMatches();if(e.length===0){this.updateRoundPanels();return}this.tournament.active=!0,this.tournament.baseSetup=structuredClone(this.setup),this.tournament.matches=e,this.tournament.currentMatchIndex=-1,this.tournament.standings=Object.fromEntries(m.map(i=>[i,{played:0,wins:0,losses:0}])),this.mode="tournament",this.launchNextTournamentMatch()}stopTournament(){this.tournament.active=!1,this.tournament.matches=[],this.tournament.currentMatchIndex=-1,this.tournament.teamMode=!1,this.updateRoundPanels()}launchNextTournamentMatch(){if(!this.tournament.active)return;const t=this.tournament.currentMatchIndex+1;if(t>=this.tournament.matches.length){this.stopTournament();return}this.tournament.currentMatchIndex=t;const e=this.tournament.matches[t],i=Object.fromEntries(m.map(o=>[o,0]));if(e.aTeam&&e.bTeam){for(const o of e.aTeam)i[o]=this.tournament.baseSetup.classCounts[o];for(const o of e.bTeam)i[o]=this.tournament.baseSetup.classCounts[o]}else i[e.a]=this.tournament.baseSetup.classCounts[e.a],i[e.b]=this.tournament.baseSetup.classCounts[e.b];this.applySetup({arenaWidth:this.tournament.baseSetup.arenaWidth,arenaHeight:this.tournament.baseSetup.arenaHeight,classCounts:i}),this.startRound(!0),this.updateRoundPanels()}completeTournamentBattle(t){if(!this.tournament.active||this.tournament.currentMatchIndex<0)return;const e=this.tournament.matches[this.tournament.currentMatchIndex];if(e.aTeam&&e.bTeam){const i=e.aTeam.includes(t),o=i?e.aTeam:e.bTeam,a=i?e.bTeam:e.aTeam;for(const s of e.aTeam)this.tournament.standings[s].played+=1;for(const s of e.bTeam)this.tournament.standings[s].played+=1;for(const s of o)this.tournament.standings[s].wins+=1;for(const s of a)this.tournament.standings[s].losses+=1}else this.tournament.standings[e.a].played+=1,this.tournament.standings[e.b].played+=1,t===e.a?(this.tournament.standings[e.a].wins+=1,this.tournament.standings[e.b].losses+=1):(this.tournament.standings[e.b].wins+=1,this.tournament.standings[e.a].losses+=1);this.time.delayedCall(700,()=>{this.launchNextTournamentMatch()})}generateShareLink(){var a;const t=he(this.setup),e=this.exportReplayToken(),i=new URL(window.location.href);i.searchParams.set("setup",t),i.searchParams.set("replay",e);const o=i.toString();return o!==this.lastShareLink&&(window.history.replaceState({},"",o),this.lastShareLink=o),(a=this.ui)!=null&&a.shareLinkOutEl&&(this.ui.shareLinkOutEl.value=o),o}updateRoundPanels(){if(!this.ui)return;this.ui.roundStatusEl.innerHTML=`${this.ui.createStatusHtml()}${this.setupWarningMessage?`<br /><strong style="color:#fda4af">${this.setupWarningMessage}</strong>`:""}`,this.ui.prizeBoardEl&&(this.ui.prizeBoardEl.innerHTML=this.getPrizeBoardHtml()),this.ui.tournamentStatusEl&&(this.ui.tournamentStatusEl.innerHTML=this.getTournamentHtml()),this.ui.combatLogEl&&(this.ui.combatLogEl.innerHTML=this.getCombatLogHtml()),this.ui.achievementsEl&&(this.ui.achievementsEl.innerHTML=this.getAchievementsHtml()),this.ui.replayOutEl&&(this.ui.replayOutEl.value=this.exportReplayToken()),this.ui.rewardSummaryEl&&(this.ui.rewardSummaryEl.innerHTML=this.getRewardSummaryHtml()),this.ui.rewardChoicesEl&&(this.ui.rewardChoicesEl.innerHTML='<div class="panel">Reward is auto-picked per winning round (deterministic).</div>'),this.ui.survivorPoolEl.innerHTML="";const t=this.getSurvivorDraftPool();if(t.length===0){const e=document.createElement("span");e.textContent=this.roundFinished?"No survivors to draft.":"Survivors unlock when round ends.",e.style.fontSize="11px",e.style.color="#94a3b8",this.ui.survivorPoolEl.appendChild(e)}else for(const e of t){const i=document.createElement("span");i.className="chip",i.textContent=e.label,i.style.background=z(e.classKey),i.dataset.classKey=e.classKey,this.ui.bindDraggableChip&&this.ui.bindDraggableChip(i,e.classKey),this.ui.survivorPoolEl.appendChild(i)}if(this.ui.nextRoundBoxEl.innerHTML="",this.nextRoundBoxClasses.length===0){const e=document.createElement("span");e.textContent="Drop survivor chips here.",e.style.fontSize="11px",e.style.color="#94a3b8",this.ui.nextRoundBoxEl.appendChild(e)}else for(let e=0;e<this.nextRoundBoxClasses.length;e+=1){const i=this.nextRoundBoxClasses[e],o=document.createElement("span");o.className="chip saved",o.textContent=`${p[i].label} ${e+1}`,o.style.background=z(i),o.title="Click to remove",o.addEventListener("click",()=>{this.nextRoundBoxClasses.splice(e,1),this.updateRoundPanels()}),this.ui.nextRoundBoxEl.appendChild(o)}this.ui.shareLinkOutEl.value||(this.ui.shareLinkOutEl.value=this.generateShareLink())}applySetup(t){const e=ce(t.classCounts,ot,m);this.setupWarningMessage=e.wasCapped?`Setup capped to ${ot} total balls for stable performance.`:"",this.setup={arenaWidth:I(t.arenaWidth,X.arenaWidth),arenaHeight:I(t.arenaHeight,X.arenaHeight),classCounts:e.classCounts},this.scale.resize(this.setup.arenaWidth,this.setup.arenaHeight),this.cameras.main.setSize(this.setup.arenaWidth,this.setup.arenaHeight),this.rebuildInitialState(),this.generateShareLink()}rebuildInitialState(){this.initialState=xe(this.setup),this.resetSimulation()}showBattleComparison(t){const[e,i]=De(this);$e().show(e,i,()=>{t&&t()})}startRound(t){if(!this.roundActive){if(!t){this.showBattleComparison(()=>{this._beginRound()});return}this._beginRound()}}_beginRound(){this.balls=this.initialState.map(t=>({...t,abilityState:{...t.abilityState}}));for(const t of this.balls)this.applyUpgradesToBall(t);this.effects=[],this.stepCounter=0,this.accumulator=0,this.fastForward=!1,this.paused=!1,this.simTime=0,this.lastDamageTimesByPair.clear(),this.lastPairPruneAt=0,this.roundFinished=!1,this.winnerClassKey=null,this.roundActive=this.balls.length>0,this.lastNonEmptyClassSnapshot=this.getCurrentClassCounts(),this.nextBallId=this.balls.reduce((t,e)=>Math.max(t,e.id),-1)+1,this.renderScene(),this.updateRoundPanels()}resetSimulation(){this.balls=[],this.effects=[],this.stepCounter=0,this.accumulator=0,this.fastForward=!1,this.paused=!1,this.simTime=0,this.lastDamageTimesByPair.clear(),this.lastPairPruneAt=0,this.roundFinished=!1,this.roundActive=!1,this.winnerClassKey=null,this.lastNonEmptyClassSnapshot=Object.fromEntries(m.map(t=>[t,0])),this.nextBallId=this.initialState.reduce((t,e)=>Math.max(t,e.id),-1)+1,this.renderScene(),this.updateRoundPanels()}update(t,e){if(!this.roundActive){this.renderScene();return}if(this.paused){this.renderScene();return}this.accumulator+=e/1e3,this.accumulator=Math.min(this.accumulator,.25);const o=(this.fastForward?ne:re)*this.speedMultiplier;let a=0;for(;this.accumulator>=gt&&a<o;)this.simulateStep(gt),this.accumulator-=gt,a+=1;this.renderScene()}simulateStep(t){const e=this.balls.filter(n=>n.alive),i=new Map,o=new Map,a=[],s=this.getModeRules();this.simTime+=t,e.length>0&&(this.lastNonEmptyClassSnapshot=this.getCurrentClassCounts());for(const n of e){this.applyPerStepAbilities(n,t,e,i),n.x+=n.vx*t*s.movementMult,n.y+=n.vy*t*s.movementMult;const c=this.resolveWallCollision(n);c&&this.trySpawnSplitChildrenFromWall(n,c.x,c.y,a),this.applyArenaEffects(n,t,i,o),this.spawnTrail(n)}const l=ve(e);for(const[n,c]of l)this.resolveBallCollision(e[n],e[c],i,o,a);for(const n of e){const c=i.get(n.id)??0,h=o.get(n.id)??0,d=g(n.incomingReduction??0,0,.75);n.hp=g(n.hp-c*s.damageMult*(1-d)+h,0,n.maxHp),n.hp<=0&&(n.alive=!1)}if(this.balls=this.balls.filter(n=>n.alive),a.length>0){const n=Math.max(0,ot-this.balls.length);n>0&&this.balls.push(...a.slice(0,n))}for(const n of this.balls)this.capSpeed(n),n.x=ft(n.x),n.y=ft(n.y),n.vx=ft(n.vx),n.vy=ft(n.vy);this.pruneCollisionDamageCache(),this.evaluateWinnerState(),this.updateEffects(t),this.stepCounter+=1,this.stepCounter%15===0&&this.updateRoundPanels()}applyPerStepAbilities(t,e,i,o){const a=p[t.classKey];t.abilityState.splitCooldownLeft>0&&(t.abilityState.splitCooldownLeft=Math.max(0,t.abilityState.splitCooldownLeft-e)),t.abilityState.bossShockwaveCooldown>0&&(t.abilityState.bossShockwaveCooldown=Math.max(0,t.abilityState.bossShockwaveCooldown-e)),t.abilityState.bossRoarCooldown>0&&(t.abilityState.bossRoarCooldown=Math.max(0,t.abilityState.bossRoarCooldown-e)),t.abilityState.bossChargeCooldown>0&&(t.abilityState.bossChargeCooldown=Math.max(0,t.abilityState.bossChargeCooldown-e)),t.abilityState.swordsmanSlashCooldown>0&&(t.abilityState.swordsmanSlashCooldown=Math.max(0,t.abilityState.swordsmanSlashCooldown-e)),t.abilityState.archerShotCooldown>0&&(t.abilityState.archerShotCooldown=Math.max(0,t.abilityState.archerShotCooldown-e)),t.abilityState.mutationCooldown>0&&(t.abilityState.mutationCooldown=Math.max(0,t.abilityState.mutationCooldown-e));const s=t.mutationKey?_[t.mutationKey]:null,l=(a.regenPerSecond??0)+((s==null?void 0:s.ability)==="regen"?s.regenPerSecond??0:0);if(l>0&&(t.hp=Math.min(t.maxHp,t.hp+l*e),(this.stepCounter+t.id)%28===0&&this.effects.push({type:"plus",x:t.x,y:t.y-t.r-7,color:6747034,life:.22})),t.classKey==="trickster"&&(t.abilityState.tricksterDashTimer-=e,t.abilityState.tricksterDashTimer<=0&&(t.vx*=a.dashMultiplier,t.vy*=a.dashMultiplier,t.abilityState.tricksterDashTimer=a.dashCooldown,this.effects.push({type:"ring",x:t.x,y:t.y,color:16768358,life:.35,radius:t.r}))),(s==null?void 0:s.ability)==="dash"&&t.classKey!=="trickster"&&t.abilityState.mutationCooldown<=0&&(t.vx*=s.dashMultiplier??1.22,t.vy*=s.dashMultiplier??1.22,t.abilityState.mutationCooldown=s.cooldown??3.8,this.effects.push({type:"ring",x:t.x,y:t.y,color:16436245,life:.28,radius:t.r+2})),t.classKey==="bulwark"&&(t.abilityState.bulwarkShieldTimeLeft>0?t.abilityState.bulwarkShieldTimeLeft=Math.max(0,t.abilityState.bulwarkShieldTimeLeft-e):(t.abilityState.bulwarkShieldCooldown-=e,t.abilityState.bulwarkShieldCooldown<=0&&(t.abilityState.bulwarkShieldTimeLeft=a.shieldDuration,t.abilityState.bulwarkShieldCooldown=a.shieldCooldown,this.effects.push({type:"ring",x:t.x,y:t.y,color:11989503,life:.42,radius:t.r+2})))),t.classKey==="boss"){if(!t.abilityState.bossEnraged&&t.hp<=t.maxHp*(a.enrageThreshold??.45)&&(t.abilityState.bossEnraged=!0,t.outgoingBonus=(t.outgoingBonus??0)+(a.enrageOutgoingBonus??0),t.incomingReduction=g((t.incomingReduction??0)+(a.enrageIncomingReduction??0),0,.75),t.vx*=a.enrageSpeedMult??1,t.vy*=a.enrageSpeedMult??1,this.effects.push({type:"ring",x:t.x,y:t.y,color:16739125,life:.56,radius:t.r+8}),this.logCombatEvent(`Boss #${t.id} enraged`)),t.abilityState.bossChargeCooldown<=0){const n=(this.stepCounter*13+t.id*17)%360*Math.PI/180,c=a.chargeForce??100;t.vx+=Math.cos(n)*c,t.vy+=Math.sin(n)*c,t.abilityState.bossChargeCooldown=a.chargeCooldown??1.7,this.effects.push({type:"spark",x:t.x,y:t.y,color:16772565,life:.28})}t.abilityState.bossRoarCooldown<=0&&this.triggerBossRoar(t,i,o)}if(t.classKey==="swordsman"||(s==null?void 0:s.ability)==="sword"){const n=t.classKey==="swordsman"?a:s;t.abilityState.swordsmanSlashCooldown<=0&&(this.triggerSwordSlash(t,i,o,n,t.classKey==="swordsman"?16486972:16498468),t.abilityState.swordsmanSlashCooldown=n.slashCooldown??1.25)}if(t.classKey==="archer"||(s==null?void 0:s.ability)==="archer"){const n=t.classKey==="archer"?a:s;t.abilityState.archerShotCooldown<=0&&(this.triggerArcherShot(t,i,o,n,t.classKey==="archer"?8843180:16639626),t.abilityState.archerShotCooldown=n.shotCooldown??1)}}triggerSwordSlash(t,e,i,o,a){const s=o.slashRadius??90,l=s*s,n=o.slashDamage??8,c=o.slashPush??64;let h=0;for(const d of e){if(d.id===t.id||!d.alive)continue;const u=d.x-t.x,f=d.y-t.y,x=u*u+f*f;if(x>l)continue;const S=Math.sqrt(x)||1,y=u/S,v=f/S;d.vx+=y*c,d.vy+=v*c,i.set(d.id,(i.get(d.id)??0)+n),h+=1}this.effects.push({type:"slash",x:t.x,y:t.y,color:a,life:.25,radius:s}),h>0&&this.stepCounter%18===0&&this.logCombatEvent(`${p[t.classKey].label} #${t.id} slash hit ${h}`)}triggerArcherShot(t,e,i,o,a){let s=null,l=Number.POSITIVE_INFINITY;const n=o.shotRange??280,c=n*n;for(const f of e){if(!f.alive||f.id===t.id)continue;const x=f.x-t.x,S=f.y-t.y,y=x*x+S*S;y>c||y<l&&(s=f,l=y)}if(!s)return;const h=Math.sqrt(l)||1,d=(s.x-t.x)/h,u=(s.y-t.y)/h;s.vx+=d*(o.shotPush??55),s.vy+=u*(o.shotPush??55),i.set(s.id,(i.get(s.id)??0)+(o.shotDamage??9)),this.effects.push({type:"arrow",x:t.x,y:t.y,tx:s.x,ty:s.y,color:a,life:.2}),this.stepCounter%20===0&&this.logCombatEvent(`${p[t.classKey].label} #${t.id} shot #${s.id}`)}triggerBossRoar(t,e,i){const o=p.boss;t.abilityState.bossRoarCooldown=o.roarCooldown??1.1;const a=o.roarRadius??170,s=a*a,l=(o.roarDamage??8)*(t.abilityState.bossEnraged?1.35:1),n=o.roarPush??110;let c=0;for(const h of e){if(h.id===t.id||!h.alive)continue;const d=h.x-t.x,u=h.y-t.y,f=d*d+u*u;if(f>s)continue;const x=Math.sqrt(f)||1,S=d/x,y=u/x;h.vx+=S*n,h.vy+=y*n,i.set(h.id,(i.get(h.id)??0)+l),c+=1}c>0&&(this.effects.push({type:"ring",x:t.x,y:t.y,color:t.abilityState.bossEnraged?16743001:16761707,life:.34,radius:a}),this.stepCounter%20===0&&this.logCombatEvent(`Boss roar hit ${c}`))}applyArenaEffects(t,e,i,o){const a=this.getArenaRules();if(a.hazardTick&&this.stepCounter%a.hazardTick===0){const s=Math.floor(this.stepCounter/a.hazardTick),l=s*41%this.setup.arenaWidth,n=s*37%this.setup.arenaHeight;(Math.abs(t.x-l)<t.r*.7||Math.abs(t.y-n)<t.r*.7)&&i.set(t.id,(i.get(t.id)??0)+a.hazardDamage)}if(a.sanctumRadius){const s=this.setup.arenaWidth*.5,l=this.setup.arenaHeight*.5,n=t.x-s,c=t.y-l;n*n+c*c<=a.sanctumRadius*a.sanctumRadius&&o.set(t.id,(o.get(t.id)??0)+a.sanctumHealingPerSecond*e)}}resolveWallCollision(t){const e=t.r,i=this.setup.arenaWidth-t.r,o=t.r,a=this.setup.arenaHeight-t.r,s=p[t.classKey].wallBounceMult??1;let l=!1,n=0,c=0;if(t.x<e?(t.x=e,t.vx=Math.abs(t.vx)*s,l=!0,n=1,c=0):t.x>i&&(t.x=i,t.vx=-Math.abs(t.vx)*s,l=!0,n=-1,c=0),t.y<o?(t.y=o,t.vy=Math.abs(t.vy)*s,l=!0,n=0,c=1):t.y>a&&(t.y=a,t.vy=-Math.abs(t.vy)*s,l=!0,n=0,c=-1),l){const h=this.getArenaRules();return h.wallThorns&&(t.hp=Math.max(0,t.hp-h.wallThorns)),this.effects.push({type:"spark",x:t.x,y:t.y,color:14212841,life:.2}),{x:n,y:c}}return null}resolveBallCollision(t,e,i,o,a){const s=e.x-t.x,l=e.y-t.y,n=t.r+e.r,c=s*s+l*l;if(c>=n*n)return;let h=Math.sqrt(c),d=1,u=0;h>0?(d=s/h,u=l/h):h=0;const f=n-h;if(f>0){const B=1/t.mass,P=1/e.mass,H=B+P;t.x-=d*f*(B/H),t.y-=u*f*(B/H),e.x+=d*f*(P/H),e.y+=u*f*(P/H)}const x=e.vx-t.vx,S=e.vy-t.vy,y=x*d+S*u,v=Math.max(0,-y),T=this.getPairKey(t.id,e.id),b=this.canDealCollisionDamage(T),M=Se({a:t,b:e,impact:v,normalX:d,normalY:u,canDealDamage:b}),D=1+(t.outgoingBonus??0),q=1+(e.outgoingBonus??0);if(M.damageToB*=D,M.damageToA*=q,M.healingForA*=D,M.healingForB*=q,b&&(M.damageToA>0||M.damageToB>0)&&(this.lastDamageTimesByPair.set(T,this.simTime),i.set(t.id,(i.get(t.id)??0)+M.damageToA+M.thornsToA),i.set(e.id,(i.get(e.id)??0)+M.damageToB+M.thornsToB),o.set(t.id,(o.get(t.id)??0)+M.healingForA),o.set(e.id,(o.get(e.id)??0)+M.healingForB)),this.effects.push({type:"spark",x:(t.x+e.x)*.5,y:(t.y+e.y)*.5,color:16777215,life:g(.14+v/900,.14,.36)}),this.tryBossShockwave(t,e,d,u),this.tryBossShockwave(e,t,-d,-u),this.trySpawnSplitChildren(t,e,v,d,u,a),this.trySpawnSplitChildren(e,t,v,-d,-u,a),y<0){const B=1/t.mass,P=1/e.mass,H=-1.98*y/(B+P),K=H*d,O=H*u;t.vx-=K*B,t.vy-=O*B,e.vx+=K*P,e.vy+=O*P}}tryBossShockwave(t,e,i,o){if(t.classKey!=="boss"||t.abilityState.bossShockwaveCooldown>0)return;const a=p.boss,s=a.shockwaveIntervalSteps??8;if((this.stepCounter+t.id+e.id)%s!==0)return;const l=a.shockwavePush??75,n=a.shockwaveRecoil??.2;e.vx+=i*l,e.vy+=o*l,t.vx-=i*l*n,t.vy-=o*l*n,t.abilityState.bossShockwaveCooldown=a.shockwaveCooldown??.5,this.effects.push({type:"ring",x:t.x,y:t.y,color:16761707,life:.25,radius:t.r+6}),this.stepCounter%24===0&&this.logCombatEvent(`Boss shockwave from #${t.id}`)}trySpawnSplitChildren(t,e,i,o,a,s){if(t.classKey!=="splitter"||!t.alive)return;const l=p.splitter;if(this.balls.length+s.length>=ot||t.abilityState.splitCooldownLeft>0||t.abilityState.splitDepth>=l.maxSplitDepth||i<l.splitImpactThreshold)return;const n=-a,c=o,h=Math.max(8,Math.round(t.r*l.childRadiusMult)),d=Math.max(1,t.hp*l.childHpRatio),u=Math.max(180,Math.hypot(t.vx,t.vy)*l.childSpeedMult),f=h+3;t.alive=!1,t.hp=0;for(const x of[-1,1]){const S=t.x+n*f*x,y=t.y+c*f*x,v=t.vx+n*u*.45*x+o*42,T=t.vy+c*u*.45*x+a*42,b=yt(this.nextBallId,"splitter",S,y,v,T);b.r=h,b.mass=Math.max(.42,t.mass*.62),b.maxHp=d,b.hp=d,b.abilityState.splitDepth=t.abilityState.splitDepth+1,b.abilityState.splitCooldownLeft=l.splitCooldown,this.applyUpgradesToBall(b),s.push(b),this.nextBallId+=1}this.effects.push({type:"ring",x:t.x,y:t.y,color:6220500,life:.35,radius:t.r+4}),this.logCombatEvent(`Splitter #${t.id} split on impact`),this.effects.push({type:"spark",x:(t.x+e.x)*.5,y:(t.y+e.y)*.5,color:10090212,life:.25})}trySpawnSplitChildrenFromWall(t,e,i,o){if(t.classKey!=="splitter"||!t.alive)return;const a=p.splitter;if(t.abilityState.splitCooldownLeft>0||t.abilityState.splitDepth>=a.maxSplitDepth||this.balls.length+o.length>=ot)return;const s=-i,l=e,n=Math.max(8,Math.round(t.r*a.childRadiusMult)),c=Math.max(1,t.hp*a.childHpRatio),h=Math.max(170,Math.hypot(t.vx,t.vy)*a.childSpeedMult),d=n+3;t.alive=!1,t.hp=0;for(const u of[-1,1]){const f=t.x+s*d*u,x=t.y+l*d*u,S=t.vx+s*h*.35*u+e*34,y=t.vy+l*h*.35*u+i*34,v=yt(this.nextBallId,"splitter",f,x,S,y);v.r=n,v.mass=Math.max(.42,t.mass*.62),v.maxHp=c,v.hp=c,v.abilityState.splitDepth=t.abilityState.splitDepth+1,v.abilityState.splitCooldownLeft=a.splitCooldown,this.applyUpgradesToBall(v),o.push(v),this.nextBallId+=1}this.effects.push({type:"ring",x:t.x,y:t.y,color:10090212,life:.3,radius:t.r+5}),this.logCombatEvent(`Splitter #${t.id} split on wall`)}capSpeed(t){const e=t.vx*t.vx+t.vy*t.vy,i=nt*nt;if(e>i){const o=Math.sqrt(e),a=nt/o;t.vx*=a,t.vy*=a}}getPairKey(t,e){return t<e?`${t}:${e}`:`${e}:${t}`}canDealCollisionDamage(t){const e=this.lastDamageTimesByPair.get(t);return e==null?!0:this.simTime-e>=oe}pruneCollisionDamageCache(){if(!(this.simTime-this.lastPairPruneAt<.6)){this.lastPairPruneAt=this.simTime;for(const[t,e]of this.lastDamageTimesByPair.entries())this.simTime-e>ae&&this.lastDamageTimesByPair.delete(t)}}spawnTrail(t){Math.hypot(t.vx,t.vy)<200||(this.stepCounter+t.id)%3!==0||this.effects.push({type:"trail",x:t.x,y:t.y,color:t.color,life:.18})}updateEffects(t){for(const e of this.effects)e.life-=t;this.effects=this.effects.filter(e=>e.life>0),this.effects.length>Pt&&(this.effects=this.effects.slice(this.effects.length-Pt))}getPixelMask(t){if(this.pixelMaskCache.has(t))return this.pixelMaskCache.get(t);const e=[];for(let i=-t;i<=t;i+=pt)for(let o=-t;o<=t;o+=pt)o*o+i*i<=t*t&&e.push([o,i]);return this.pixelMaskCache.set(t,e),e}drawPixelBall(t){const e=t.r,i=R.Display.Color.IntegerToColor(t.color),o=R.Display.Color.GetColor(g(i.red+48,0,255),g(i.green+48,0,255),g(i.blue+48,0,255)),a=R.Display.Color.GetColor(g(i.red-42,0,255),g(i.green-42,0,255),g(i.blue-42,0,255)),s=R.Display.Color.GetColor(g(i.red+20,0,255),g(i.green+20,0,255),g(i.blue+20,0,255));t.classKey==="boss"&&(this.graphics.lineStyle(3,16761707,.9),this.graphics.strokeCircle(t.x,t.y,e+6),this.graphics.lineStyle(1,2101508,.6),this.graphics.strokeCircle(t.x,t.y,e+10));const l=this.getPixelMask(e);for(const[c,h]of l){let d=t.color;c+h<-e*.25?d=o:c+h>e*.4?d=a:Math.abs(c)+Math.abs(h)<e*.4&&(d=s),this.graphics.fillStyle(d,1),this.graphics.fillRect(t.x+c,t.y+h,pt,pt)}this.graphics.fillStyle(1118481,1),this.graphics.fillRect(t.x-e,t.y-e,e*2,1),this.graphics.fillRect(t.x-e,t.y+e-1,e*2,1),this.graphics.fillRect(t.x-e,t.y-e,1,e*2),this.graphics.fillRect(t.x+e-1,t.y-e,1,e*2),this.graphics.fillStyle(16317180,.55),this.graphics.fillRect(t.x-Math.floor(e*.45),t.y-Math.floor(e*.45),2,2)}drawClassArt(t){const e=Math.round(t.x),i=Math.round(t.y),o=this.getClassGlyph(t.classKey);for(const a of o.dark)this.graphics.fillStyle(724760,.95),this.graphics.fillRect(e+a[0],i+a[1],a[2],a[3]);for(const a of o.light)this.graphics.fillStyle(12571866,.9),this.graphics.fillRect(e+a[0],i+a[1],a[2],a[3])}drawClassEquipment(t){const e=this.stepCounter*.09+t.id*.17,i=Math.sin(e),o=Math.atan2(t.vy,t.vx||1e-4),a=t.x,s=t.y;if(t.classKey==="swordsman"){const l=t.r+10,n=o+i*.55,c=a+Math.cos(n)*l,h=s+Math.sin(n)*l;this.graphics.lineStyle(4,13358561,.95),this.graphics.strokeLineShape(new R.Geom.Line(a,s,c,h)),this.graphics.lineStyle(2,16347926,.9),this.graphics.strokeLineShape(new R.Geom.Line(a,s,a+Math.cos(n-.25)*(l-4),s+Math.sin(n-.25)*(l-4)));return}if(t.classKey==="archer"){const l=Math.max(8,t.r-4),n=a+Math.cos(o)*2,c=s+Math.sin(o)*2;this.graphics.lineStyle(2,2278750,.95),this.graphics.strokeCircle(n,c,l);const h=l+8,d=n+Math.cos(o)*h,u=c+Math.sin(o)*h;this.graphics.lineStyle(2,16317180,.95),this.graphics.strokeLineShape(new R.Geom.Line(n,c,d,u)),this.graphics.fillStyle(16317180,.95),this.graphics.fillRect(d-2,u-2,4,4);return}if(t.classKey==="tank")this.graphics.lineStyle(3,9684477,.9),this.graphics.strokeRect(a-7,s-7,14,14);else if(t.classKey==="striker"){const l=a+Math.cos(o)*(t.r+3),n=s+Math.sin(o)*(t.r+3);this.graphics.fillStyle(16478597,.95),this.graphics.fillRect(l-3,n-3,6,6)}else t.classKey==="medic"?(this.graphics.fillStyle(8843180,.95),this.graphics.fillRect(a-1,s-6,2,12),this.graphics.fillRect(a-6,s-1,12,2)):t.classKey==="trickster"?(this.graphics.lineStyle(2,16436245,.9),this.graphics.strokeLineShape(new R.Geom.Line(a-7,s+6,a+7,s-6)),this.graphics.strokeLineShape(new R.Geom.Line(a-7,s-6,a+7,s+6))):t.classKey==="sniper"?(this.graphics.lineStyle(2,15324671,.9),this.graphics.strokeCircle(a,s,6),this.graphics.fillStyle(15324671,.95),this.graphics.fillRect(a+6,s-1,5,2)):t.classKey==="vampire"?(this.graphics.fillStyle(16622767,.9),this.graphics.fillRect(a-4,s+3,2,4),this.graphics.fillRect(a+2,s+3,2,4)):t.classKey==="bulwark"?(this.graphics.lineStyle(3,10090212,.85),this.graphics.strokeCircle(a,s,t.r-2)):t.classKey==="splitter"?(this.graphics.lineStyle(2,6220500,.9),this.graphics.strokeLineShape(new R.Geom.Line(a-6,s-6,a+6,s+6)),this.graphics.strokeLineShape(new R.Geom.Line(a+6,s-6,a-6,s+6))):t.classKey==="boss"&&(this.graphics.fillStyle(16498468,.95),this.graphics.fillRect(a-7,s-t.r-6,14,3),this.graphics.fillRect(a-5,s-t.r-9,2,3),this.graphics.fillRect(a-1,s-t.r-10,2,4),this.graphics.fillRect(a+3,s-t.r-9,2,3))}getClassGlyph(t){if(this.classGlyphCache.has(t))return this.classGlyphCache.get(t);const e={dark:[],light:[]};return t==="tank"?e.dark.push([-4,-4,8,8],[-8,-1,16,2]):t==="striker"?e.dark.push([2,-7,2,6],[-4,-1,10,2],[-8,5,2,2]):t==="medic"?e.dark.push([-1,-6,2,12],[-6,-1,12,2]):t==="trickster"?e.dark.push([-6,2,12,2],[-2,-6,2,8],[2,-6,2,8]):t==="sniper"?e.dark.push([-7,-1,14,2],[6,-2,2,4]):t==="vampire"?e.dark.push([-5,-4,3,8],[2,-4,3,8],[-2,2,4,4]):t==="bulwark"?(e.dark.push([-6,-5,12,10]),e.light.push([-1,-3,2,6])):t==="splitter"?e.dark.push([-7,-1,14,2],[-1,-7,2,14],[-5,-5,2,2],[3,3,2,2]):t==="swordsman"?e.dark.push([-1,-8,2,16],[-5,-6,10,2],[-3,6,6,2]):t==="archer"?(e.dark.push([-6,-5,2,10],[4,-5,2,10],[-4,-6,8,2],[-4,4,8,2]),e.light.push([-1,-1,2,2])):t==="boss"&&e.dark.push([-10,2,20,3],[-8,-6,16,2],[-9,-9,3,3],[-1,-10,2,4],[6,-9,3,3]),this.classGlyphCache.set(t,e),e}drawEffects(){for(const t of this.effects){const e=g(t.life*4,0,1);if(t.type==="trail")this.graphics.fillStyle(t.color,e*.5),this.graphics.fillRect(t.x-2,t.y-2,4,4);else if(t.type==="spark")this.graphics.fillStyle(t.color,e),this.graphics.fillRect(t.x-1,t.y-1,3,3),this.graphics.fillRect(t.x-5,t.y-1,2,2),this.graphics.fillRect(t.x+3,t.y-1,2,2),this.graphics.fillRect(t.x-1,t.y-5,2,2),this.graphics.fillRect(t.x-1,t.y+3,2,2);else if(t.type==="ring")this.graphics.lineStyle(2,t.color,e),this.graphics.strokeCircle(t.x,t.y,(t.radius??10)+(1-e)*6);else if(t.type==="slash"){const i=(t.radius??64)*(1-e*.5);this.graphics.lineStyle(3,t.color,e),this.graphics.strokeCircle(t.x,t.y,i*.55),this.graphics.lineStyle(2,t.color,e*.85),this.graphics.strokeLineShape(new R.Geom.Line(t.x-i*.8,t.y+2,t.x+i*.8,t.y-2))}else t.type==="arrow"?(this.graphics.lineStyle(2,t.color,e),this.graphics.strokeLineShape(new R.Geom.Line(t.x,t.y,t.tx,t.ty)),this.graphics.fillStyle(t.color,e),this.graphics.fillRect(t.tx-2,t.ty-2,4,4)):t.type==="plus"&&(this.graphics.fillStyle(t.color,e),this.graphics.fillRect(t.x-1,t.y-4,2,8),this.graphics.fillRect(t.x-4,t.y-1,8,2))}}drawAbilityCooldown(t){let e=null,i=9149364;if(t.classKey==="trickster"){const n=p.trickster.dashCooldown??1;e=g((t.abilityState.tricksterDashTimer??0)/n,0,1),i=15774761}else if(t.classKey==="swordsman"){const n=p.swordsman.slashCooldown??1;e=g((t.abilityState.swordsmanSlashCooldown??0)/n,0,1),i=16486972}else if(t.classKey==="archer"){const n=p.archer.shotCooldown??1;e=g((t.abilityState.archerShotCooldown??0)/n,0,1),i=8843180}else if(t.classKey==="bulwark"){const n=p.bulwark.shieldCooldown??1;(t.abilityState.bulwarkShieldTimeLeft??0)>0?(e=0,i=10217471):(e=g((t.abilityState.bulwarkShieldCooldown??0)/n,0,1),i=8239050)}else if(t.classKey==="boss"){const n=p.boss,c=g((t.abilityState.bossShockwaveCooldown??0)/(n.shockwaveCooldown??.5),0,1),h=g((t.abilityState.bossRoarCooldown??0)/(n.roarCooldown??1.1),0,1),d=g((t.abilityState.bossChargeCooldown??0)/(n.chargeCooldown??1.7),0,1);e=Math.max(c,h,d),i=16761707}else if(t.mutationKey&&_[t.mutationKey]){const n=_[t.mutationKey];n.ability==="dash"?(e=g((t.abilityState.mutationCooldown??0)/(n.cooldown??3.8),0,1),i=16498468):n.ability==="sword"?(e=g((t.abilityState.swordsmanSlashCooldown??0)/(n.slashCooldown??1.75),0,1),i=16498468):n.ability==="archer"&&(e=g((t.abilityState.archerShotCooldown??0)/(n.shotCooldown??1.35),0,1),i=16639626)}if(e==null)return;const o=Math.max(10,Math.floor(t.r*1.1)),a=3,s=t.x-o/2,l=t.y+t.r+8;this.graphics.fillStyle(988970,.9),this.graphics.fillRect(s,l,o,a),this.graphics.fillStyle(i,.95),this.graphics.fillRect(s+1,l+1,(o-2)*(1-e),a-2)}drawArenaOverlay(){const t=this.getArenaRules();if(t.sanctumRadius&&(this.graphics.lineStyle(2,7663794,.5),this.graphics.strokeCircle(this.setup.arenaWidth*.5,this.setup.arenaHeight*.5,t.sanctumRadius)),t.hazardTick){const e=Math.floor(this.stepCounter/t.hazardTick),i=e*41%this.setup.arenaWidth,o=e*37%this.setup.arenaHeight;this.graphics.lineStyle(1,16743034,.45),this.graphics.strokeLineShape(new R.Geom.Line(i,0,i,this.setup.arenaHeight)),this.graphics.strokeLineShape(new R.Geom.Line(0,o,this.setup.arenaWidth,o))}}renderScene(){this.graphics.clear(),this.graphics.fillStyle(1120294,1),this.graphics.fillRect(0,0,this.setup.arenaWidth,this.setup.arenaHeight),this.graphics.fillStyle(1779256,1);for(let s=0;s<this.setup.arenaHeight;s+=28)for(let l=s/28%2===0?0:14;l<this.setup.arenaWidth;l+=28)this.graphics.fillRect(l,s,14,14);this.graphics.fillStyle(660258,.18);for(let s=0;s<this.setup.arenaWidth;s+=52)this.graphics.fillRect(s,0,2,this.setup.arenaHeight);for(let s=0;s<this.setup.arenaHeight;s+=52)this.graphics.fillRect(0,s,this.setup.arenaWidth,2);this.graphics.lineStyle(it,12502480,1),this.graphics.strokeRect(it/2,it/2,this.setup.arenaWidth-it,this.setup.arenaHeight-it),this.graphics.fillStyle(725536,.2),this.graphics.fillRect(0,0,this.setup.arenaWidth,40),this.graphics.fillRect(0,this.setup.arenaHeight-40,this.setup.arenaWidth,40),this.drawArenaOverlay();for(const s of this.balls){this.drawPixelBall(s),this.drawClassArt(s),this.drawClassEquipment(s),s.classKey==="bulwark"&&s.abilityState.bulwarkShieldTimeLeft>0&&(this.graphics.lineStyle(2,11071743,.8),this.graphics.strokeCircle(s.x,s.y,s.r+4)),s.classKey==="boss"&&(this.graphics.lineStyle(1,16773582,.45),this.graphics.strokeCircle(s.x,s.y,s.r+12));const l=s.r*2,n=4,c=g(s.hp/s.maxHp,0,1),h=s.x-l/2,d=s.y-s.r-11;this.graphics.fillStyle(1053462,1),this.graphics.fillRect(h,d,l,n);const u=R.Display.Color.Interpolate.ColorWithColor(R.Display.Color.ValueToColor(14498876),R.Display.Color.ValueToColor(3524938),100,Math.floor(c*100));this.graphics.fillStyle(R.Display.Color.GetColor(u.r,u.g,u.b),1),this.graphics.fillRect(h+1,d+1,(l-2)*c,n-2),this.drawAbilityCooldown(s)}if(this.balls.length===0&&!this.roundFinished&&(this.graphics.fillStyle(330002,.74),this.graphics.fillRect(this.setup.arenaWidth/2-200,this.setup.arenaHeight/2-32,400,64),this.graphics.lineStyle(2,9415119,.95),this.graphics.strokeRect(this.setup.arenaWidth/2-200,this.setup.arenaHeight/2-32,400,64)),this.drawEffects(),this.roundFinished){const s=Math.min(520,this.setup.arenaWidth-60),l=54,n=(this.setup.arenaWidth-s)/2,c=20;this.graphics.fillStyle(396054,.82),this.graphics.fillRect(n,c,s,l),this.graphics.lineStyle(2,this.winnerClassKey?p[this.winnerClassKey].color:16317180,1),this.graphics.strokeRect(n,c,s,l),this.graphics.fillStyle(16317180,1),this.graphics.fillRect(n+18,c+20,s-36,2);const h=this.winnerClassKey?`${p[this.winnerClassKey].label} WINS`:"DRAW";this.winnerText.setVisible(!0),this.winnerText.setText(h),this.winnerText.setColor(this.winnerClassKey?z(this.winnerClassKey):"#f8fafc"),this.winnerText.setPosition(this.setup.arenaWidth/2,c+l/2)}else this.roundActive?this.winnerText.setVisible(!1):(this.winnerText.setVisible(!0),this.winnerText.setText("PRESS START ROUND"),this.winnerText.setColor("#cbd5e1"),this.winnerText.setPosition(this.setup.arenaWidth/2,this.setup.arenaHeight/2));const t=m.map(s=>`${p[s].label}:${this.setup.classCounts[s]}`).join(" "),e=this.getCurrentClassCounts(),i=m.map(s=>`${p[s].label}:${e[s]}`).join(" "),o=[...m].map(s=>({classKey:s,prize:this.prizeLedger[s]})).sort((s,l)=>l.prize-s.prize||m.indexOf(s.classKey)-m.indexOf(l.classKey))[0],a=this.tournament.active?`  tournament:${this.tournament.currentMatchIndex+1}/${this.tournament.matches.length}`:"";this.hudText.setText(`mode:${this.getModeLabel(this.mode)} (${this.mode})  step:${this.stepCounter}  alive:${this.balls.length}  size:${this.setup.arenaWidth}x${this.setup.arenaHeight}${a}
setup:${t}
alive:${i}
leader:${p[o.classKey].label} ${o.prize}
state:${this.roundActive?"running":this.roundFinished?"finished":"ready"}  speed:${this.speedMultiplier}x  fast-forward:${this.fastForward?"ON":"OFF"}  paused:${this.paused?"ON":"OFF"}${this.roundFinished?`
winner:${this.winnerClassKey?p[this.winnerClassKey].label:"Draw"}`:""}`)}}const We={type:R.AUTO,width:St.arenaWidth,height:St.arenaHeight,backgroundColor:"#1a1d26",pixelArt:!0,antialias:!1,roundPixels:!0,scene:Ke};new R.Game(We);
